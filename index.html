
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Padfolio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#f0f2f7;--surface:#fff;--surface2:#f3f4f8;--border:#e4e6f0;
  --accent:#5b5ef4;--accent2:#0ea5e9;--accent-soft:#5b5ef420;
  --text:#0d0d1a;--muted:#8890a8;--green:#22c55e;--red:#ef4444;
  --shadow:0 1px 4px #0000000e;--shadow-md:0 4px 16px #00000014;--shadow-lg:0 8px 40px #00000020;--r:14px;
  --fs:14px;
}
[data-theme="dark"]{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#22263a;--border:#2e3347;
  --text:#e8eaf6;--muted:#6b7280;
  --shadow:0 1px 4px #00000050;--shadow-md:0 4px 16px #00000060;--shadow-lg:0 8px 40px #00000070;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;font-size:var(--fs);min-height:100vh;transition:background .3s,color .3s;}
button,input,textarea,select{font-family:'Inter',sans-serif;font-size:var(--fs);}
button{cursor:pointer;}
a{text-decoration:none;}

/* â”€â”€ GATE (zorunlu giriÅŸ ekranÄ±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#gate{position:fixed;inset:0;background:linear-gradient(135deg,#1a1d27 0%,#0f1117 100%);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;}
#gate.gone{display:none;}
.gate-box{background:#1e2235;border:1px solid #2e3347;border-radius:24px;padding:40px 36px;width:100%;max-width:420px;box-shadow:0 24px 64px #00000060;animation:pop .3s ease;}
.gate-logo{font-size:28px;font-weight:800;background:linear-gradient(135deg,#5b5ef4,#0ea5e9);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;margin-bottom:6px;}
.gate-tagline{text-align:center;color:#6b7280;font-size:13px;margin-bottom:28px;}
.gate-tabs{display:flex;background:#22263a;border-radius:10px;padding:3px;margin-bottom:24px;}
.gate-tab{flex:1;padding:8px;border-radius:8px;font-size:13px;font-weight:600;border:none;background:none;color:#6b7280;transition:all .2s;cursor:pointer;}
.gate-tab.active{background:#5b5ef4;color:#fff;}
.gate-form{display:none;}
.gate-form.active{display:block;}
.g-label{font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.g-input{width:100%;padding:11px 13px;background:#22263a;border:1.5px solid #2e3347;border-radius:10px;color:#e8eaf6;outline:none;transition:border-color .2s;margin-bottom:12px;}
.g-input:focus{border-color:#5b5ef4;}
.g-input::placeholder{color:#4b5563;}
.g-err{font-size:12px;color:#ef4444;margin-top:-8px;margin-bottom:10px;display:none;}
.g-btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:700;background:linear-gradient(135deg,#5b5ef4,#0ea5e9);color:#fff;transition:all .15s;margin-top:4px;}
.g-btn:hover{opacity:.88;}
.g-btn:active{transform:scale(.97);}

/* â”€â”€ OVERLAY / MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:#00000060;z-index:800;display:flex;align-items:center;justify-content:center;padding:16px;}
.overlay.hidden{display:none;}
.modal{background:var(--surface);border-radius:20px;padding:32px;width:100%;max-width:460px;box-shadow:var(--shadow-lg);animation:pop .22s ease;max-height:90vh;overflow-y:auto;}
@keyframes pop{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
.modal-title{font-size:18px;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.modal-close{margin-left:auto;background:none;border:none;font-size:20px;color:var(--muted);line-height:1;cursor:pointer;}
.modal-close:hover{color:var(--text);}

/* â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
nav{background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.nav-inner{max-width:1160px;margin:0 auto;padding:0 18px;height:54px;display:flex;align-items:center;gap:10px;}
.nav-logo{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;margin-right:4px;cursor:pointer;}
.search-wrap{position:relative;flex:1;max-width:300px;}
.search-input{width:100%;padding:8px 12px 8px 34px;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;font-size:13px;color:var(--text);outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.search-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none;}
.nav-links{display:flex;gap:2px;}
.nav-link{padding:6px 11px;border-radius:8px;font-size:13px;font-weight:500;color:var(--muted);border:none;background:none;transition:all .15s;}
.nav-link:hover{background:var(--surface2);color:var(--text);}
.nav-link.active{background:var(--accent-soft);color:var(--accent);font-weight:600;}
.nav-right{display:flex;align-items:center;gap:6px;margin-left:auto;}
.nav-av-wrap{display:flex;align-items:center;gap:7px;padding:4px 9px;border-radius:10px;cursor:pointer;transition:background .15s;}
.nav-av-wrap:hover{background:var(--surface2);}
.nav-username{font-size:13px;font-weight:600;}
.nav-btn{padding:7px 13px;border-radius:9px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .15s;}
.btn-ghost{background:var(--surface2);color:var(--text);}
.btn-ghost:hover{background:var(--border);}
.notif-btn{position:relative;width:34px;height:34px;border-radius:9px;font-size:16px;background:var(--surface2);border:none;color:var(--text);transition:background .15s;display:flex;align-items:center;justify-content:center;}
.notif-btn:hover{background:var(--border);}
.notif-badge{position:absolute;top:1px;right:1px;width:14px;height:14px;background:var(--red);border-radius:50%;font-size:8px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--surface);}
.notif-badge.hidden{display:none;}

/* â”€â”€ AVATAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.av{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;font-size:18px;line-height:1;}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{max-width:1160px;margin:0 auto;padding:18px;display:grid;grid-template-columns:240px 1fr 260px;gap:16px;align-items:start;}
@media(max-width:900px){.layout{grid-template-columns:1fr;}.sl,.sr{display:none;}}
.sl,.sr{position:sticky;top:70px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);margin-bottom:12px;}
.card-hd{padding:12px 14px;font-size:11px;font-weight:700;border-bottom:1px solid var(--border);color:var(--muted);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;justify-content:space-between;}

/* â”€â”€ MINI PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mp-cover{height:60px;background:linear-gradient(135deg,var(--accent),var(--accent2));}
.mp-av-wrap{position:relative;margin:-22px 0 0 14px;display:inline-block;}
.mp-edit-btn{position:absolute;bottom:0;right:0;width:18px;height:18px;background:var(--accent);border-radius:50%;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--surface);}
.mp-info{padding:8px 14px 0;}
.mp-name{font-size:14px;font-weight:700;}
.mp-sub{font-size:11px;color:var(--muted);margin-top:1px;cursor:pointer;}
.mp-sub:hover{color:var(--accent);}
.mp-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);border-top:1px solid var(--border);margin-top:12px;}
.mp-stat{background:var(--surface);padding:10px 4px;text-align:center;}
.mp-stat-num{font-size:15px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.mp-stat-label{font-size:10px;color:var(--muted);}

/* â”€â”€ QUICK NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.qnav{padding:6px;}
.qnav-btn{width:100%;display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:9px;font-size:13px;font-weight:500;color:var(--text);border:none;background:none;cursor:pointer;transition:background .12s;text-align:left;}
.qnav-btn:hover{background:var(--surface2);}
.qnav-btn.active{background:var(--accent-soft);color:var(--accent);font-weight:600;}

/* â”€â”€ CAT HAMBURGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cat-hd{padding:12px 14px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;border-bottom:1px solid var(--border);}
.cat-hd:hover{background:var(--surface2);}
.cat-toggle-icon{font-size:15px;transition:transform .25s;line-height:1;}
.cat-dropdown{display:none;animation:catOpen .2s ease;}
@keyframes catOpen{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.cat-dropdown.open{display:block;}
.cat-item{display:flex;align-items:center;gap:8px;padding:9px 10px;cursor:pointer;font-size:13px;font-weight:500;transition:background .12s;}
.cat-item:hover{background:var(--surface2);}
.cat-item.active{background:var(--accent-soft);color:var(--accent);font-weight:700;}
.cat-ic{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}

/* â”€â”€ STORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stories{display:flex;gap:8px;overflow-x:auto;padding:14px;scrollbar-width:none;}
.stories::-webkit-scrollbar{display:none;}
.story{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;}
.story-ring{width:52px;height:52px;border-radius:50%;padding:2.5px;background:linear-gradient(135deg,var(--accent),var(--accent2));}
.story-av{width:100%;height:100%;border-radius:50%;border:2px solid var(--surface);display:flex;align-items:center;justify-content:center;font-size:20px;}
.story-name{font-size:10px;color:var(--muted);max-width:54px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* â”€â”€ COMPOSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.compose-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:12px;box-shadow:var(--shadow);}
.compose-row{display:flex;gap:10px;align-items:center;}
.compose-fake{flex:1;padding:10px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:30px;font-size:13px;color:var(--muted);cursor:text;transition:border-color .2s;}
.compose-fake:hover{border-color:var(--accent);}
.compose-expanded{margin-top:12px;display:none;}
.compose-expanded.open{display:block;}
.c-input{width:100%;padding:9px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;color:var(--text);outline:none;margin-bottom:7px;transition:border-color .2s;}
.c-input:focus{border-color:var(--accent);}
textarea.c-input{resize:none;min-height:70px;max-height:160px;line-height:1.5;}
.compose-footer{display:flex;align-items:center;justify-content:space-between;margin-top:9px;flex-wrap:wrap;gap:7px;}
.compose-cats{display:flex;gap:4px;flex-wrap:wrap;}
.cat-pill{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:none;color:var(--muted);transition:all .15px;}
.cat-pill.selected{border-color:var(--accent);color:var(--accent);background:var(--accent-soft);}
.post-btn{padding:8px 18px;border:none;border-radius:9px;font-size:13px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;}
.post-btn:hover{opacity:.85;}

/* â”€â”€ FEED TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feed-tabs{display:flex;gap:3px;margin-bottom:12px;background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:4px;box-shadow:var(--shadow);}
.feed-tab{flex:1;padding:8px;border-radius:8px;font-size:13px;font-weight:600;border:none;background:none;color:var(--muted);cursor:pointer;transition:all .15s;}
.feed-tab.active{background:var(--accent-soft);color:var(--accent);}

/* â”€â”€ POST CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.post-card{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .15s;}
.post-card:hover{box-shadow:var(--shadow-md);}
.post-card.pinned{border-color:#f59e0b66;}
.pin-badge{font-size:11px;color:#b45309;font-weight:600;padding:8px 16px 0;display:block;}
.post-top{display:flex;align-items:center;gap:9px;padding:12px 16px 8px;}
.post-av{width:40px;height:40px;cursor:pointer;}
.post-meta{flex:1;}
.post-author{font-size:14px;font-weight:700;cursor:pointer;}
.post-author:hover{color:var(--accent);}
.post-date{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.post-body-wrap{padding:0 16px 12px;}
.post-title{font-size:15px;font-weight:700;margin-bottom:5px;line-height:1.4;cursor:pointer;}
.post-title:hover{color:var(--accent);}
.post-preview{font-size:13px;color:var(--muted);line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.post-stats{display:flex;gap:12px;padding:8px 16px;font-size:12px;color:var(--muted);}
.post-actions{display:flex;border-top:1px solid var(--border);}
.act{flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:9px 6px;font-size:13px;font-weight:500;border:none;background:none;color:var(--muted);cursor:pointer;transition:background .12s;}
.act:hover{background:var(--surface2);}
.act.liked{color:var(--red);}
.act.saved{color:var(--accent);}
.act svg{width:15px;height:15px;flex-shrink:0;}
.act-mini{padding:5px 8px;border-radius:7px;font-size:12px;border:none;background:none;color:var(--muted);cursor:pointer;transition:background .12s;}
.act-mini:hover{background:var(--surface2);}
.search-highlight{background:#fef08a;border-radius:2px;}

/* â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.back-btn{display:flex;align-items:center;gap:5px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;margin-bottom:14px;padding:4px 0;width:fit-content;}
.back-btn:hover{color:var(--accent);}
.detail-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);margin-bottom:12px;overflow:hidden;}
.detail-title{font-size:20px;font-weight:800;margin-bottom:10px;line-height:1.35;}
.detail-body{font-size:14px;line-height:1.8;color:var(--muted);white-space:pre-wrap;}

/* â”€â”€ COMMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.comments-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);}
.comments-hd{padding:14px 16px;font-size:14px;font-weight:700;border-bottom:1px solid var(--border);}
.comments-body{padding:14px 16px;}
.comment-compose{display:flex;gap:9px;margin-bottom:14px;}
.comment-ta{flex:1;padding:9px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;font-size:13px;outline:none;resize:none;min-height:50px;color:var(--text);line-height:1.5;}
.comment-ta:focus{border-color:var(--accent);}
.comment-send{align-self:flex-end;padding:9px 14px;border:none;border-radius:9px;font-size:12px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;}
.comment{display:flex;gap:9px;padding:10px 0;border-bottom:1px solid var(--border);}
.comment:last-child{border-bottom:none;}
.comment-right{flex:1;}
.comment-bubble{background:var(--surface2);border-radius:0 12px 12px 12px;padding:9px 12px;}
.comment-author{font-size:12px;font-weight:700;cursor:pointer;margin-bottom:3px;}
.comment-author:hover{color:var(--accent);}
.comment-text{font-size:13px;color:var(--muted);line-height:1.5;}
.comment-date{font-size:10px;color:var(--muted);margin-top:4px;font-family:'JetBrains Mono',monospace;}

/* â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-cover{height:100px;}
.profile-av-area{position:relative;display:inline-block;margin:-32px 0 0 20px;}
.profile-edit-btn{position:absolute;bottom:0;right:0;width:22px;height:22px;background:var(--accent);border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--surface);}
.profile-info{padding:10px 20px 16px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.profile-name{font-size:20px;font-weight:800;}
.profile-join{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border-top:1px solid var(--border);}
.stat-box{background:var(--surface);padding:12px 4px;text-align:center;}
.stat-num{font-size:18px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.stat-label{font-size:10px;color:var(--muted);}

/* â”€â”€ FRIEND BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.friend-btn{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:5px;}
.friend-btn.add{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;}
.friend-btn.add:hover{opacity:.85;}
.friend-btn.pending{background:var(--surface2);color:var(--muted);border:1.5px solid var(--border);}
.friend-btn.accept{background:#22c55e;color:#fff;border:none;}
.friend-btn.friends{background:#22c55e18;color:#16a34a;border:1.5px solid #22c55e;}
.friend-btn.friends:hover{background:#ef444418;color:var(--red);border-color:var(--red);}
.dm-btn{padding:8px 14px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;background:var(--surface2);color:var(--text);border:1.5px solid var(--border);transition:all .15s;display:inline-flex;align-items:center;gap:5px;}
.dm-btn:hover{border-color:var(--accent);color:var(--accent);}

/* â”€â”€ FRIENDS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.friends-tabs{display:flex;gap:3px;margin-bottom:14px;background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:4px;}
.friends-tab{flex:1;padding:8px;border-radius:8px;font-size:13px;font-weight:600;border:none;background:none;color:var(--muted);cursor:pointer;transition:all .15s;}
.friends-tab.active{background:var(--accent-soft);color:var(--accent);}
.friend-row{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--border);}
.friend-row:last-child{border-bottom:none;}
.friend-row-name{font-size:14px;font-weight:700;cursor:pointer;}
.friend-row-name:hover{color:var(--accent);}
.friend-row-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.fr-actions{display:flex;gap:6px;margin-left:auto;}
.fr-accept{padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;cursor:pointer;}
.fr-reject{padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;background:var(--surface2);color:var(--muted);border:1px solid var(--border);cursor:pointer;}
.fr-reject:hover{color:var(--red);border-color:var(--red);}

/* â”€â”€ DM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dm-layout{display:grid;grid-template-columns:220px 1fr;min-height:500px;}
.dm-sidebar{border-right:1px solid var(--border);display:flex;flex-direction:column;}
.dm-sidebar-hd{padding:10px 14px;font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.dm-section-label{padding:8px 14px 3px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;background:var(--surface2);}
.dm-new-group-btn{padding:4px 9px;border:1.5px solid var(--accent);border-radius:8px;font-size:11px;font-weight:700;color:var(--accent);background:none;cursor:pointer;transition:all .15s;white-space:nowrap;}
.dm-new-group-btn:hover{background:var(--accent);color:#fff;}
.dm-conv{display:flex;align-items:center;gap:9px;padding:10px 14px;cursor:pointer;transition:background .12s;border-bottom:1px solid var(--border);}
.dm-conv:hover{background:var(--surface2);}
.dm-conv.active{background:var(--accent-soft);}
.dm-conv-name{font-size:13px;font-weight:700;}
.dm-conv-preview{font-size:11px;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px;}
.dm-chat{display:flex;flex-direction:column;}
.dm-chat-hd{padding:12px 16px;font-size:13px;font-weight:700;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px;}
.dm-messages{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:10px;min-height:360px;max-height:400px;}
.dm-msg{display:flex;gap:8px;align-items:flex-end;}
.dm-msg.mine{flex-direction:row-reverse;}
.dm-bubble{max-width:260px;padding:9px 13px;border-radius:16px;font-size:13px;line-height:1.5;}
.dm-bubble.theirs{background:var(--surface2);border-bottom-left-radius:4px;}
.dm-bubble.mine{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-bottom-right-radius:4px;}
.dm-sender-name{font-size:10px;font-weight:700;color:var(--accent);margin-bottom:2px;}
.dm-time{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.dm-input-area{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;}
.dm-input{flex:1;padding:9px 13px;background:var(--surface2);border:1.5px solid var(--border);border-radius:20px;font-size:13px;outline:none;color:var(--text);}
.dm-input:focus{border-color:var(--accent);}
.dm-send{padding:9px 16px;border:none;border-radius:20px;font-size:13px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;}
.dm-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--muted);gap:8px;font-size:13px;padding:40px;}
.dm-sidebar{border-right:1px solid var(--border);display:flex;flex-direction:column;}
.dm-sidebar-hd{padding:10px 14px;font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.dm-section-label{padding:8px 14px 3px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;background:var(--surface2);}
.dm-new-group-btn{padding:4px 9px;border:1.5px solid var(--accent);border-radius:8px;font-size:11px;font-weight:700;color:var(--accent);background:none;cursor:pointer;transition:all .15s;white-space:nowrap;}
.dm-new-group-btn:hover{background:var(--accent);color:#fff;}
.dm-sender-name{font-size:10px;font-weight:700;color:var(--accent);margin-bottom:2px;}
.group-icon{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.group-member-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:9px;cursor:pointer;transition:background .12s;}
.group-member-item:hover{background:var(--surface2);}
.group-member-item.selected{background:var(--accent-soft);border:1.5px solid var(--accent)!important;}
.group-check{width:20px;height:20px;border-radius:6px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;font-weight:700;transition:all .15s;}
.group-member-item.selected .group-check{background:var(--accent);border-color:var(--accent);color:#fff;}
.group-members-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;min-height:24px;}
.group-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;background:var(--accent-soft);color:var(--accent);border-radius:20px;font-size:11px;font-weight:600;}
.group-icon{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.group-member-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:9px;cursor:pointer;transition:background .12s;}
.group-member-item:hover{background:var(--surface2);}
.group-member-item.selected{background:var(--accent-soft);border:1.5px solid var(--accent)!important;}
.group-check{width:20px;height:20px;border-radius:6px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;font-weight:700;transition:all .15s;}
.group-member-item.selected .group-check{background:var(--accent);border-color:var(--accent);color:#fff;}
.group-members-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;min-height:24px;}
.group-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;background:var(--accent-soft);color:var(--accent);border-radius:20px;font-size:11px;font-weight:600;}

/* â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-sec{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:14px;overflow:hidden;}
.settings-sec-hd{padding:12px 18px;font-size:11px;font-weight:800;background:var(--surface2);border-bottom:1px solid var(--border);color:var(--muted);text-transform:uppercase;letter-spacing:.8px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);}
.settings-row:last-child{border-bottom:none;}
.s-label{font-size:14px;font-weight:600;}
.s-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.toggle{position:relative;width:42px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:30px;cursor:pointer;transition:.3s;}
.toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;}
.toggle input:checked+.toggle-slider{background:linear-gradient(135deg,var(--accent),var(--accent2));}
.toggle input:checked+.toggle-slider:before{transform:translateX(18px);}
.s-select{padding:7px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;color:var(--text);outline:none;}
.s-select:focus{border-color:var(--accent);}
.danger-btn{padding:8px 16px;border-radius:9px;font-size:13px;font-weight:700;background:#ef444415;color:var(--red);border:1.5px solid var(--red);cursor:pointer;transition:all .15s;}
.danger-btn:hover{background:var(--red);color:#fff;}
.logout-btn{padding:8px 16px;border-radius:9px;font-size:13px;font-weight:700;background:var(--surface2);color:var(--text);border:1.5px solid var(--border);cursor:pointer;transition:all .15s;}
.logout-btn:hover{background:var(--border);}

/* â”€â”€ AVATAR PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.av-picker-body{padding:4px 0;}
.av-preview-row{display:flex;justify-content:center;padding:16px 0 8px;}
.av-preview-circle{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;box-shadow:var(--shadow-md);transition:all .2s;}
.av-section-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:12px 0 8px;}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;margin-bottom:4px;}
.emoji-opt{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:2.5px solid transparent;background:var(--surface2);transition:all .15s;}
.emoji-opt:hover{border-color:var(--accent);transform:scale(1.1);}
.emoji-opt.selected{border-color:var(--accent);background:var(--accent-soft);}
.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;margin-bottom:8px;}
.color-opt{width:38px;height:38px;border-radius:9px;cursor:pointer;border:3px solid transparent;transition:all .15s;}
.color-opt:hover{transform:scale(1.08);}
.color-opt.selected{border-color:var(--text);outline:2px solid var(--accent);outline-offset:2px;}
.av-btns{display:flex;gap:8px;margin-top:12px;}
.av-save{flex:1;padding:11px;border:none;border-radius:10px;font-size:14px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;}
.av-save:hover{opacity:.88;}
.av-cancel{padding:11px 18px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-weight:600;background:none;color:var(--muted);cursor:pointer;}
.av-cancel:hover{border-color:var(--accent);color:var(--accent);}

/* â”€â”€ NOTIFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notif-item{display:flex;align-items:center;gap:11px;padding:13px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;}
.notif-item:hover{background:var(--surface2);}
.notif-item.unread{background:var(--accent-soft);}
.notif-item:last-child{border-bottom:none;}
.notif-text{flex:1;font-size:13px;line-height:1.5;}
.notif-time{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;}

/* â”€â”€ ONLINE / LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.online-list{padding:6px;}
.online-row{display:flex;align-items:center;gap:9px;padding:7px 8px;border-radius:9px;cursor:pointer;transition:background .12s;}
.online-row:hover{background:var(--surface2);}
.online-dot{width:9px;height:9px;background:var(--green);border-radius:50%;border:2px solid var(--surface);margin-left:-10px;margin-bottom:-10px;z-index:1;flex-shrink:0;}
.online-name{font-size:13px;font-weight:600;flex:1;}
.online-time{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.lb-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;}
.lb-row:hover{background:var(--surface2);}
.lb-row:last-child{border-bottom:none;}
.lb-rank{font-size:16px;font-weight:800;width:24px;text-align:center;flex-shrink:0;}
.lb-rank.gold{color:#f59e0b;}.lb-rank.silver{color:#94a3b8;}.lb-rank.bronze{color:#b45309;}
.lb-info{flex:1;}
.lb-name{font-size:13px;font-weight:700;}
.lb-score{font-size:11px;color:var(--muted);}

/* â”€â”€ EMPTY / LOADING / TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:var(--r);height:110px;margin-bottom:10px;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-icon{font-size:36px;margin-bottom:10px;}
.loading{display:flex;align-items:center;justify-content:center;gap:5px;padding:28px;}
.ld{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 1.2s infinite;}
.ld:nth-child(2){animation-delay:.2s;}.ld:nth-child(3){animation-delay:.4s;}
@keyframes blink{0%,100%{opacity:.15;}50%{opacity:1;}}
.toast-wrap{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;align-items:flex-end;pointer-events:none;}
.toast{background:#1a1a2e;color:#fff;padding:11px 18px;border-radius:12px;font-size:13px;font-weight:600;box-shadow:0 8px 32px #00000040;animation:toastIn .25s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;gap:8px;border-left:3px solid #5b5ef4;}
.toast.success{border-left-color:#22c55e;}.toast.error{border-left-color:#ef4444;}.toast.info{border-left-color:#0ea5e9;}
.toast.out{animation:toastOut .2s ease forwards;}
@keyframes toastIn{from{opacity:0;transform:translateX(40px) scale(.9);}to{opacity:1;transform:translateX(0) scale(1);}}
@keyframes toastOut{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(40px);}}
.page-title{font-size:20px;font-weight:800;margin-bottom:16px;}
.search-result-hd{font-size:13px;color:var(--muted);margin-bottom:10px;font-weight:500;}
.announce{background:var(--accent-soft);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;font-size:13px;}

/* â”€â”€ EMOJI PICKER POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.emoji-picker-popup{display:none;flex-wrap:wrap;gap:4px;padding:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;margin-top:6px;max-height:160px;overflow-y:auto;box-shadow:var(--shadow-md);}
.emoji-picker-popup.open{display:flex;}

/* â”€â”€ BÄ°YOGRAFÄ° / DURUM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-bio{font-size:13px;color:var(--muted);padding:0 20px 10px;line-height:1.6;}
.profile-status-note{display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1.5px solid var(--border);border-radius:20px;padding:5px 12px;font-size:12px;font-weight:600;color:var(--text);margin:0 20px 14px;max-width:calc(100% - 40px);}
.profile-status-dot{width:8px;height:8px;background:var(--green);border-radius:50%;flex-shrink:0;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.bio-edit-area{padding:12px 16px;border-top:1px solid var(--border);}
.bio-input{width:100%;padding:8px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;color:var(--text);outline:none;font-size:13px;resize:none;line-height:1.5;}
.bio-input:focus{border-color:var(--accent);}
.status-input{width:100%;padding:8px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;color:var(--text);outline:none;font-size:13px;margin-bottom:7px;}
.status-input:focus{border-color:var(--accent);}
.bio-save-btn{padding:7px 16px;border:none;border-radius:9px;font-size:13px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;}
.bio-save-btn:hover{opacity:.85;}

.admin-tab{padding:6px 14px;border-radius:8px;border:1.5px solid var(--border);background:var(--surface2);color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
.admin-tab.active,.admin-tab:hover{background:var(--accent-soft);color:var(--accent);border-color:var(--accent);}
.adm-btn{padding:5px 12px;border-radius:8px;border:none;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
.adm-btn-red{background:#ef444415;color:#ef4444;border:1.5px solid #ef444430;}
.adm-btn-red:hover{background:#ef4444;color:#fff;}
.adm-btn-blue{background:var(--accent-soft);color:var(--accent);border:1.5px solid var(--accent);}


@keyframes msgPopupIn{0%{opacity:0;transform:translateX(120px) scale(.85)}65%{transform:translateX(-6px) scale(1.02)}100%{opacity:1;transform:translateX(0) scale(1)}}
@keyframes msgPopupOut{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(90px)}}
@keyframes msgProgressBar{from{transform:scaleX(1)}to{transform:scaleX(0)}}
@keyframes popupPing{0%{transform:scale(1);opacity:.8}100%{transform:scale(2.4);opacity:0}}
#msgPopup{position:fixed;top:72px;right:20px;background:var(--surface);border:1.5px solid var(--accent);border-radius:16px;padding:13px 14px 16px;box-shadow:0 12px 48px #00000045,0 0 0 4px var(--accent-soft);z-index:99999;display:flex;align-items:center;gap:12px;max-width:300px;cursor:pointer;animation:msgPopupIn .4s cubic-bezier(.34,1.56,.64,1) forwards;}
.mp-av-wrap{position:relative;flex-shrink:0}.mp-ping{position:absolute;top:-3px;right:-3px;width:13px;height:13px;background:var(--accent);border-radius:50%;animation:popupPing .7s ease-out 2}
.mp-name{font-size:13px;font-weight:700;margin-bottom:2px}.mp-text{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:175px}
.mp-close{position:absolute;top:7px;right:9px;background:none;border:none;font-size:16px;color:var(--muted);cursor:pointer;opacity:.6;line-height:1;padding:2px 5px}
.mp-close:hover{opacity:1}.mp-body{flex:1;min-width:0}
.mp-progress{position:absolute;bottom:0;left:0;height:3px;background:var(--accent);border-radius:0 0 16px 16px;width:100%;transform-origin:left;animation:msgProgressBar 4.2s linear forwards}
.dm-del-btn{padding:5px 10px;border:1.5px solid #ef444430;border-radius:8px;background:#ef444410;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap}
.dm-del-btn:hover{background:#ef4444;color:#fff}
.adm-quick-del{position:absolute;top:8px;right:8px;padding:3px 9px;border:none;border-radius:7px;background:#ef444420;color:#ef4444;font-size:11px;font-weight:700;cursor:pointer;opacity:0;transition:all .15s;pointer-events:none}
.post-card:hover .adm-quick-del{opacity:1;pointer-events:auto}

/* â”€â”€ MOBÄ°L OPTÄ°MÄ°ZASYON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
  /* Nav */
  .nav-inner{padding:0 10px;height:auto;flex-wrap:wrap;gap:6px;padding-top:8px;padding-bottom:8px;}
  .nav-logo{font-size:17px;}
  .search-wrap{order:3;width:100%;max-width:100%;flex:none;}
  .nav-links{order:4;width:100%;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;flex-wrap:nowrap;}
  .nav-links::-webkit-scrollbar{display:none;}
  .nav-link{padding:5px 9px;font-size:12px;white-space:nowrap;}
  .nav-right{order:2;margin-left:auto;}
  .nav-username{display:none;}

  /* Layout */
  .layout{padding:10px;gap:10px;}

  /* Feed / Compose */
  .compose-card{padding:10px;}
  .post-card{padding:12px;}

  /* DM - mobilde tek kolon */
  .dm-layout{grid-template-columns:1fr;}
  .dm-sidebar{display:none;}
  .dm-sidebar.mobile-show{display:flex;}

  /* Friends tabs */
  .friends-tabs{flex-wrap:wrap;}

  /* Modal */
  .modal{padding:20px 16px;margin:10px;}
  .overlay{padding:10px;align-items:flex-end;}
  .modal{border-radius:20px 20px 0 0;max-height:85vh;}

  /* Gate */
  .gate-box{padding:28px 20px;}

  /* Emoji grid */
  .emoji-grid{grid-template-columns:repeat(7,1fr);}
  .color-grid{grid-template-columns:repeat(7,1fr);}

  /* Toast */
  .toast-wrap{bottom:10px;right:10px;left:10px;align-items:stretch;}
  .toast{font-size:12px;}

  /* Settings */
  .settings-row{flex-wrap:wrap;gap:8px;}

  /* Profile */
  .profile-status-note{font-size:11px;padding:4px 10px;}

  /* Post actions */
  .post-actions{flex-wrap:wrap;gap:6px;}
  .post-act{font-size:12px;padding:5px 8px;}

  /* Page title */
  .page-title{font-size:16px;}

  /* Announce */
  .announce{font-size:12px;padding:10px 12px;}
}

@media(max-width:400px){
  .nav-link{font-size:11px;padding:4px 7px;}
  .gate-box{padding:22px 14px;}
  .emoji-grid{grid-template-columns:repeat(6,1fr);}
  .color-grid{grid-template-columns:repeat(6,1fr);}
}
</style>
</head>
<body>

<!-- â”€â”€â”€ GATE (Zorunlu GiriÅŸ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="gate">
  <div class="gate-box">
    <div class="gate-logo">Padfolio</div>
    <div class="gate-tagline">TopluluÄŸa katÄ±l, paylaÅŸ, keÅŸfet ğŸš€</div>
    <div id="gateLoading" style="text-align:center;color:#6b7280;font-size:12px;margin-bottom:10px;">â³ Sunucuya baÄŸlanÄ±lÄ±yor...</div>
    <div class="gate-tabs">
      <button class="gate-tab active" onclick="switchGateTab('login')">GiriÅŸ Yap</button>
      <button class="gate-tab" onclick="switchGateTab('register')">KayÄ±t Ol</button>
    </div>
    <!-- Login -->
    <div class="gate-form active" id="gateLogin">
      <div class="g-label">KullanÄ±cÄ± AdÄ±</div>
      <input class="g-input" id="gLoginUser" placeholder="kullanici_adi" autocomplete="off"/>
      <div class="g-label">Åifre</div>
      <input class="g-input" id="gLoginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      <div class="g-err" id="gLoginErr">KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±.</div>
      <button class="g-btn" id="gLoginBtn">GiriÅŸ Yap â†’</button>
    </div>
    <!-- Register -->
    <div class="gate-form" id="gateRegister">
      <div class="g-label">KullanÄ±cÄ± AdÄ±</div>
      <input class="g-input" id="gRegUser" placeholder="kullanici_adi" maxlength="20" autocomplete="off"/>
      <div class="g-err" id="gRegUserErr">En az 3 karakter, boÅŸluk olmadan.</div>
      <div class="g-label">Åifre</div>
      <input class="g-input" id="gRegPass" type="password" placeholder="En az 6 karakter"/>
      <div class="g-err" id="gRegPassErr">En az 6 karakter olmalÄ±.</div>
      <button class="g-btn" id="gRegBtn">KayÄ±t Ol â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ AVATAR PICKER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay hidden" id="avModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-title">âœ¨ Profili Ã–zelleÅŸtir <button class="modal-close" onclick="closeAvModal()">Ã—</button></div>
    <div class="av-picker-body">
      <div class="av-preview-row"><div class="av-preview-circle" id="avPreview"></div></div>
      <div class="av-section-label">Emoji SeÃ§</div>
      <div class="emoji-grid" id="emojiGrid"></div>
      <div class="av-section-label">Arka Plan Rengi</div>
      <div class="color-grid" id="colorGrid"></div>
      <div class="av-btns">
        <button class="av-cancel" onclick="closeAvModal()">Ä°ptal</button>
        <button class="av-save" onclick="saveAvatar()">Kaydet âœ“</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav>
  <div class="nav-inner">
    <div class="nav-logo" onclick="goHome()">Padfolio</div>
    <div class="search-wrap">
      <span class="search-ico">ğŸ”</span>
      <input class="search-input" id="searchInput" placeholder="Ara..." oninput="onSearch(this.value)"/>
    </div>
    <div class="nav-links">
      <button class="nav-link active" id="navHome" onclick="goHome()">ğŸ  Ana Sayfa</button>
      <button class="nav-link" id="navLiked" onclick="goLiked()">â¤ï¸ BeÄŸenilenler</button>
      <button class="nav-link" id="navFriends" onclick="goFriends()">ğŸ‘¥ ArkadaÅŸlar</button>
      <button class="nav-link" id="navDM" onclick="goDM()">ğŸ’¬ Mesajlar</button>
    </div>
    <div class="nav-right" id="navRight"></div>
  </div>
</nav>

<!-- â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="layout">

  <!-- LEFT SIDEBAR -->
  <div class="sl">
    <!-- Mini Profile -->
    <div class="card" style="overflow:visible">
      <div class="mp-cover" id="mpCover"></div>
      <div class="mp-av-wrap">
        <div class="av" id="mpAv" style="width:44px;height:44px;font-size:20px;border:3px solid var(--surface)">?</div>
        <div class="mp-edit-btn" id="mpEditBtn" onclick="openAvModal()" style="display:none">âœï¸</div>
      </div>
      <div class="mp-info">
        <div class="mp-name" id="mpName">YÃ¼kleniyor...</div>
        <div class="mp-sub" id="mpSub" onclick="goToMyProfile()">Profili GÃ¶r â†’</div>
        <div id="mpStatus" style="display:none;margin-top:7px;margin-bottom:2px"></div>
      </div>
      <div class="mp-stats">
        <div class="mp-stat"><div class="mp-stat-num" id="mpPosts">0</div><div class="mp-stat-label">GÃ¶nderi</div></div>
        <div class="mp-stat"><div class="mp-stat-num" id="mpComments">0</div><div class="mp-stat-label">Yorum</div></div>
        <div class="mp-stat"><div class="mp-stat-num" id="mpLikes">0</div><div class="mp-stat-label">BeÄŸeni</div></div>
      </div>
    </div>

    <!-- HÄ±zlÄ± MenÃ¼ -->
    <div class="card">
      <div class="card-hd">HÄ±zlÄ± MenÃ¼</div>
      <div class="qnav">
        <button class="qnav-btn" onclick="goFriends()">ğŸ‘¥ ArkadaÅŸlar</button>
        <button class="qnav-btn" onclick="goDM()">ğŸ’¬ Mesajlar</button>
        <button class="qnav-btn" onclick="goNotifs()">ğŸ”” Bildirimler</button>
        <button class="qnav-btn" onclick="goSettings()">âš™ï¸ Ayarlar</button>
      </div>
    </div>

    <!-- Kategoriler Hamburger -->
    <div class="card" style="overflow:visible;position:relative">
      <div class="cat-hd" id="catHd" onclick="toggleCatMenu()">
        <span>â˜° Kategoriler</span>
        <span class="cat-toggle-icon" id="catIcon">â–¾</span>
      </div>
      <div class="cat-dropdown" id="catDropdown">
        <div id="catList"></div>
      </div>
    </div>
  </div>

  <!-- MAIN AREA -->
  <div id="mainArea">

    <!-- FEED -->
    <div id="feedView">
      <div class="announce">
        <span style="font-size:20px">ğŸ“¢</span>
        <span><strong>Padfolio'ya hoÅŸ geldin!</strong> GÃ¶nderi paylaÅŸ, arkadaÅŸ edin, topluluÄŸu bÃ¼yÃ¼t!</span>
      </div>
      <div class="card" style="margin-bottom:12px">
        <div class="stories" id="storiesRow"></div>
      </div>
      <div class="compose-card" id="composeCard">
        <div class="compose-row">
          <div class="av" id="composeAv" style="width:38px;height:38px;font-size:18px">?</div>
          <div class="compose-fake" onclick="openCompose()">Ne dÃ¼ÅŸÃ¼nÃ¼yorsun?</div>
        </div>
        <div class="compose-expanded" id="composeExpanded">
          <input class="c-input" id="postTitle" placeholder="BaÅŸlÄ±k..." maxlength="120" style="font-weight:600"/>
          <textarea class="c-input" id="postBody" placeholder="Ä°Ã§eriÄŸini buraya yaz..." rows="3"></textarea>
          <div class="compose-footer">
            <div class="compose-cats" id="composeCats"></div>
            <button class="post-btn" onclick="submitPost()">PaylaÅŸ â†’</button>
          </div>
        </div>
        <!-- FIX: Sadece Duygu (emoji picker) butonu kaldÄ±, FotoÄŸraf ve Etiket kaldÄ±rÄ±ldÄ± -->
        <div style="display:flex;gap:4px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);align-items:center;flex-wrap:wrap;">
          <button style="padding:6px 12px;border:1.5px solid var(--border);background:none;border-radius:20px;font-size:13px;color:var(--muted);cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'" onclick="toggleEmojiPicker()" id="emojiPickerBtn">ğŸ˜Š Duygu Ekle</button>
          <div id="selectedEmojiBadge" style="display:none;background:var(--accent-soft);color:var(--accent);padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;display:none;align-items:center;gap:4px;" onclick="clearPostEmoji()">
            <span id="selectedEmojiText"></span>
            <span style="font-size:10px;opacity:.7">Ã— kaldÄ±r</span>
          </div>
        </div>
        <!-- Emoji Picker Popup -->
        <div id="emojiPickerPopup" class="emoji-picker-popup"></div>
      </div>
      <div class="feed-tabs">
        <button class="feed-tab active" id="tabSon" onclick="setTab('son')">ğŸ• En Son</button>
        <button class="feed-tab" id="tabTrend" onclick="setTab('trend')">ğŸ”¥ Trend</button>
      </div>
      <div id="postsContainer">
        <div class="skeleton"></div>
        <div class="skeleton" style="height:88px"></div>
        <div class="skeleton" style="height:130px"></div>
      </div>
    </div>

    <!-- DETAIL -->
    <div id="detailView" style="display:none">
      <div class="back-btn" onclick="goHome()">â† Geri dÃ¶n</div>
      <div id="detailContent"></div>
    </div>

    <!-- PROFILE -->
    <div id="profileView" style="display:none">
      <div class="back-btn" onclick="goHome()">â† Geri dÃ¶n</div>
      <div id="profileContent"></div>
    </div>

    <!-- FRIENDS -->
    <div id="friendsView" style="display:none">
      <div class="back-btn" onclick="goHome()">â† Geri dÃ¶n</div>
      <div class="page-title">ğŸ‘¥ ArkadaÅŸlar</div>
      <div class="friends-tabs">
        <button class="friends-tab active" id="ftabFriends" onclick="switchFTab('friends')">ArkadaÅŸlar</button>
        <button class="friends-tab" id="ftabRequests" onclick="switchFTab('requests')">Ä°stekler <span id="reqBadge"></span></button>
        <button class="friends-tab" id="ftabSent" onclick="switchFTab('sent')">GÃ¶nderilenler</button>
      </div>
      <div class="card"><div id="friendsListBox"></div></div>
    </div>

    <!-- DM -->
    <div id="dmView" style="display:none">
      <div class="back-btn" onclick="goHome()">&#8592; Geri dÃ¶n</div>
      <div class="page-title">&#128172; Mesajlar</div>
      <div class="card dm-layout" style="margin-bottom:0;overflow:hidden">
        <div class="dm-sidebar">
          <div class="dm-sidebar-hd">
            <span>Sohbetler</span>
            <button class="dm-new-group-btn" onclick="openGroupModal()">+ Grup</button>
          </div>
          <div id="dmConvList" style="overflow-y:auto;flex:1"></div>
        </div>
        <div id="dmChat" class="dm-chat">
          <div class="dm-empty"><div style="font-size:40px">&#128172;</div><div>Bir konuÅŸma seÃ§</div></div>
        </div>
      </div>
    </div>

    <!-- GRUP OLUSTURMA MODAL -->
    <div class="overlay hidden" id="groupModal">
      <div class="modal" style="max-width:460px">
        <div class="modal-title" id="groupModalTitle">
          ğŸ‘¥ Grup OluÅŸtur
          <button class="modal-close" onclick="closeGroupModal()">âœ•</button>
        </div>
        <div id="groupNameArea" style="margin-bottom:14px">
          <div class="g-label">Grup AdÄ± &amp; Emojisi</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="cycleGroupEmoji()" id="groupEmojiBtn" title="Emoji deÄŸiÅŸtir" style="padding:10px 13px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface2);font-size:22px;cursor:pointer;flex-shrink:0;transition:border-color .15s">ğŸ‘¥</button>
            <input class="g-input" id="groupNameInput" placeholder="Grup adÄ± gir..." maxlength="40" style="flex:1;margin-bottom:0"/>
          </div>
        </div>
        <div style="margin-bottom:10px">
          <div class="g-label">Ãœye SeÃ§ <span id="groupMemberCountLabel" style="color:var(--accent);font-weight:700"></span></div>
          <div id="groupMemberList" style="max-height:200px;overflow-y:auto;border:1.5px solid var(--border);border-radius:10px;padding:6px;background:var(--surface2)"></div>
        </div>
        <div style="margin-bottom:16px">
          <div class="g-label">SeÃ§ilenler</div>
          <div id="groupSelectedChips" style="display:flex;flex-wrap:wrap;gap:6px;min-height:28px;padding:4px 0">
            <span style="font-size:12px;color:var(--muted)">HenÃ¼z kimse seÃ§ilmedi</span>
          </div>
        </div>
        <button class="g-btn" id="groupActionBtn" onclick="createGroup()">ğŸš€ Grubu OluÅŸtur</button>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="settingsView" style="display:none">
      <div class="back-btn" onclick="goHome()">â† Geri dÃ¶n</div>
      <div class="page-title">âš™ï¸ Ayarlar</div>
      <div class="settings-sec">
        <div class="settings-sec-hd">ğŸ¨ GÃ¶rÃ¼nÃ¼m</div>
        <div class="settings-row">
          <div><div class="s-label">Koyu Tema</div><div class="s-sub">KaranlÄ±k arayÃ¼z</div></div>
          <label class="toggle"><input type="checkbox" id="darkToggle" onchange="toggleDarkAnimated(this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="s-label">ğŸ”Š Ses Efektleri</div><div class="s-sub">Mesaj, beÄŸeni ve bildirim sesleri</div></div>
          <label class="toggle"><input type="checkbox" id="soundToggle" checked onchange="soundEnabled=this.checked"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="s-label">YazÄ± Boyutu</div><div class="s-sub">ArayÃ¼z metin boyutu</div></div>
          <select class="s-select" id="fontSizeSelect" onchange="changeFontSize(this.value)">
            <option value="12">KÃ¼Ã§Ã¼k</option>
            <option value="14" selected>Normal</option>
            <option value="16">BÃ¼yÃ¼k</option>
            <option value="18">Ã‡ok BÃ¼yÃ¼k</option>
          </select>
        </div>
      </div>
      <div class="settings-sec">
        <div class="settings-sec-hd">ğŸ“ Profil</div>
        <div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:8px">
          <div><div class="s-label">Durum (Not)</div><div class="s-sub">Instagram notlarÄ± gibi kÄ±sa bir durum â€” 60 karakter</div></div>
          <div style="display:flex;gap:6px;width:100%">
            <input class="c-input" id="statusInput" placeholder="ğŸ’¬ Åu an ne yapÄ±yorsun?" maxlength="60" style="flex:1;margin:0"/>
            <button class="bio-save-btn" onclick="saveProfileInfo()">Kaydet</button>
          </div>
        </div>
        <div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:8px">
          <div><div class="s-label">Biyografi</div><div class="s-sub">Profilinde gÃ¶rÃ¼necek kÄ±sa bir tanÄ±tÄ±m â€” 150 karakter</div></div>
          <textarea class="bio-input" id="bioInput" placeholder="Kendini tanÄ±t..." maxlength="150" rows="3"></textarea>
        </div>
      </div>
      <div class="settings-sec">
        <div class="settings-sec-hd">ğŸ”’ Gizlilik</div>
        <div class="settings-row">
          <div><div class="s-label">Hesap GizliliÄŸi</div><div class="s-sub">Gizli: profilin yalnÄ±zca arkadaÅŸlara gÃ¶rÃ¼nÃ¼r</div></div>
          <label class="toggle"><input type="checkbox" id="privacyToggle" onchange="togglePrivacy(this.checked)"><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="s-label">Ã‡evrimiÃ§i Durumu</div><div class="s-sub">DiÄŸerleri seni Ã§evrimiÃ§i gÃ¶rebilir</div></div>
          <label class="toggle"><input type="checkbox" id="onlineToggle" onchange="toggleOnlineStatus(this.checked)" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="s-label">ğŸ† Lider Tablosunda GÃ¶rÃ¼n</div><div class="s-sub">KapatÄ±rsan lider tablosundan gizlenirsin</div></div>
          <label class="toggle"><input type="checkbox" id="leaderboardToggle" onchange="toggleLeaderboard(this.checked)" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="settings-row">
          <div><div class="s-label">DM KÄ±sÄ±tla</div><div class="s-sub">YalnÄ±zca arkadaÅŸlar DM gÃ¶nderebilir</div></div>
          <label class="toggle"><input type="checkbox" id="dmRestrictToggle" onchange="toggleDmRestrict(this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
      <div class="settings-sec">
        <div class="settings-sec-hd">ğŸ‘¤ Hesap</div>
        <div class="settings-row">
          <div><div class="s-label">Ã‡Ä±kÄ±ÅŸ Yap</div><div class="s-sub">Oturumu kapat</div></div>
          <button class="logout-btn" onclick="doLogout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
        <div class="settings-row">
          <div><div class="s-label">HesabÄ± Sil</div><div class="s-sub">Bu iÅŸlem geri alÄ±namaz! Åifren gerekecek.</div></div>
          <button class="danger-btn" onclick="deleteAccount()">HesabÄ± Sil ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>

    <!-- NOTIFS -->
    <div id="notifsView" style="display:none">
      <div class="back-btn" onclick="goHome()">â† Geri dÃ¶n</div>
      <div class="page-title">ğŸ”” Bildirimler</div>
      <div class="card"><div id="notifsList"></div></div>
    </div>

    <!-- LIKED -->
    <div id="likedView" style="display:none">
      <div class="back-btn" onclick="goHome()">â† Geri dÃ¶n</div>
      <div class="page-title">â¤ï¸ BeÄŸenilen GÃ¶nderiler</div>
      <div id="likedContainer"></div>
    </div>

  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="sr">
    <div class="card">
      <div class="card-hd">ğŸŸ¢ Ã‡evrimiÃ§i <span id="onlineCnt" style="color:var(--green);font-size:11px;text-transform:none;letter-spacing:0"></span></div>
      <div class="online-list" id="onlineList"></div>
    </div>
    <div class="card">
      <div class="card-hd">ğŸ† Lider Tablosu</div>
      <div id="leaderboard"></div>
    </div>
    <div class="card" id="friendSuggestions" style="margin-top:12px;overflow:hidden;display:none"></div>
  </div>
</div>

<script>
// â”€â”€â”€ Firebase dynamic import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var db, _col, _addDoc, _onSnapshot, _query, _orderBy, _limit,
    _serverTs, _doc, _setDoc, _getDoc, _updateDoc, _increment,
    _getDocs, _deleteDoc, _arrayUnion, _arrayRemove;

function col(){ return _col.apply(null, arguments); }
function addDoc(){ return _addDoc.apply(null, arguments); }
function onSnapshot(){ return _onSnapshot.apply(null, arguments); }
function qry(){ return _query.apply(null, arguments); }
function orderBy(){ return _orderBy.apply(null, arguments); }
function lmt(n){ return _limit(n); }
function serverTs(){ return _serverTs(); }
function docRef(){ return _doc.apply(null, arguments); }
function setDoc(){ return _setDoc.apply(null, arguments); }
function getDoc(){ return _getDoc.apply(null, arguments); }
function updateDoc(){ return _updateDoc.apply(null, arguments); }
function incr(n){ return _increment(n); }
function getDocs(){ return _getDocs.apply(null, arguments); }
function deleteDoc(){ return _deleteDoc.apply(null, arguments); }
function arrUnion(){ return _arrayUnion.apply(null, arguments); }
function arrRemove(){ return _arrayRemove.apply(null, arguments); }

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var GRADS=[['#6366f1','#818cf8'],['#0ea5e9','#38bdf8'],['#22c55e','#4ade80'],['#f97316','#fb923c'],['#ec4899','#f472b6'],['#14b8a6','#2dd4bf'],['#8b5cf6','#a78bfa'],['#f59e0b','#fbbf24']];
var EMOJIS=['ğŸ˜Š','ğŸ˜','ğŸ¤©','ğŸ˜‚','ğŸ¥³','ğŸ¤”','ğŸ˜´','ğŸ¤¯','ğŸ‘‘','ğŸ¦','ğŸ¯','ğŸ¦Š','ğŸ¸','ğŸ§','ğŸ¦„','ğŸ‰','ğŸŒŸ','âš¡','ğŸ”¥','â„ï¸','ğŸŒŠ','ğŸŒˆ','ğŸ’','ğŸš€','ğŸ®','ğŸ¸','âš½','ğŸ€','ğŸ¯','ğŸ­','ğŸŒ™','â˜€ï¸','ğŸ•','ğŸ¦','ğŸµ','ğŸ¤–','ğŸ‘¾','ğŸ’€','ğŸ§ ','ğŸ²'];
var AV_COLORS=['#6366f1','#0ea5e9','#22c55e','#f97316','#ec4899','#14b8a6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#84cc16','#a855f7','#f43f5e','#10b981','#3b82f6','#eab308','#1a1a2e','#0f172a','#334155','#374151'];
var CATS=[
  {id:'all',label:'TÃ¼mÃ¼',icon:'ğŸŒ',color:'#6366f1'},
  {id:'genel',label:'Genel',icon:'ğŸ’¬',color:'#8b5cf6'},
  {id:'tech',label:'Teknoloji',icon:'ğŸ’»',color:'#0ea5e9'},
  {id:'oyun',label:'Oyun',icon:'ğŸ®',color:'#22c55e'},
  {id:'film',label:'Film/Dizi',icon:'ğŸ¬',color:'#f97316'},
  {id:'muzik',label:'MÃ¼zik',icon:'ğŸµ',color:'#ec4899'},
  {id:'spor',label:'Spor',icon:'âš½',color:'#14b8a6'},
  {id:'bilim',label:'Bilim',icon:'ğŸ”¬',color:'#f59e0b'},
];

// â”€â”€â”€ POST EMOJI PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var POST_EMOJIS=['ğŸ˜Š','ğŸ˜','ğŸ¤©','ğŸ˜‚','ğŸ¥³','ğŸ¤”','ğŸ˜´','ğŸ¤¯','ğŸ‘‘','ğŸ¦','ğŸ¯','ğŸ¦Š','ğŸ¸','ğŸ§','ğŸ¦„','ğŸ‰','ğŸŒŸ','âš¡','ğŸ”¥','â„ï¸','ğŸŒŠ','ğŸŒˆ','ğŸ’','ğŸš€','ğŸ®','ğŸ¸','âš½','ğŸ€','ğŸ¯','ğŸ­','ğŸŒ™','â˜€ï¸','ğŸ•','ğŸ¦','ğŸµ','ğŸ¤–','ğŸ‘¾','ğŸ’€','ğŸ§ ','ğŸ²','â¤ï¸','ğŸ’”','ğŸ˜','ğŸ¥°','ğŸ˜­','ğŸ˜¤','ğŸ˜¡','ğŸ˜±','ğŸ¤—','ğŸ™','ğŸ‘','ğŸ’ª','ğŸ‰','âœ¨','ğŸŒ¹','ğŸ¦‹','ğŸ€','ğŸŒ»','ğŸŒº','ğŸŒ¸','ğŸ«¶','ğŸ¥²','ğŸ˜Œ','ğŸ˜','ğŸ¤­','ğŸ«¡','ğŸ˜‡','ğŸ¤‘','ğŸ˜ˆ','ğŸ’¯','ğŸ”¥','ğŸ’¥','ğŸŒŠ','ğŸŠ','ğŸ¶','ğŸ¤','ğŸ–¤','ğŸ’œ','ğŸ’™','ğŸ’š','ğŸ’›','ğŸ§¡','â¤ï¸â€ğŸ”¥'];
var selectedPostEmoji = '';
var emojiPickerOpen = false;

function toggleEmojiPicker(){
  openCompose();
  var popup = document.getElementById('emojiPickerPopup');
  if(!popup) return;
  emojiPickerOpen = !emojiPickerOpen;
  if(emojiPickerOpen){
    popup.innerHTML = POST_EMOJIS.map(function(e){
      return '<span title="'+e+'" style="font-size:22px;cursor:pointer;padding:4px;border-radius:7px;transition:transform .1s,background .1s;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;" onmouseover="this.style.transform=\'scale(1.25)\';this.style.background=\'var(--accent-soft)\'" onmouseout="this.style.transform=\'scale(1)\';this.style.background=\'transparent\'" onclick="selectPostEmoji(\''+e+'\')">'+e+'</span>';
    }).join('');
    popup.classList.add('open');
  } else {
    popup.classList.remove('open');
  }
}

function selectPostEmoji(emoji){
  selectedPostEmoji = emoji;
  // GÃ¶ster seÃ§ili emoji badge
  var badge = document.getElementById('selectedEmojiBadge');
  var text = document.getElementById('selectedEmojiText');
  if(badge && text){
    text.textContent = emoji + ' Duygu seÃ§ildi';
    badge.style.display = 'inline-flex';
  }
  // Picker'Ä± kapat
  var popup = document.getElementById('emojiPickerPopup');
  if(popup) popup.classList.remove('open');
  emojiPickerOpen = false;
  // Emoji'yi textarea'ya ekle
  var ta = document.getElementById('postBody');
  if(ta){
    var cur = ta.value;
    ta.value = cur + (cur ? ' ' : '') + emoji;
    ta.focus();
  }
}

function clearPostEmoji(){
  selectedPostEmoji = '';
  var badge = document.getElementById('selectedEmojiBadge');
  if(badge){ badge.style.display = 'none'; }
  var text = document.getElementById('selectedEmojiText');
  if(text){ text.textContent = ''; }
}

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var currentUser = null;
var allPosts = [];
var allUsers = [];
var activeCat = 'all';
var activeTab = 'son';
var activeFTab = 'friends';
var activeDmUser = null;
var catMenuOpen = false;
var pickerEmoji = 'ğŸ˜Š';
var pickerColor = '#6366f1';
var postsUnsub = null;
var commentsUnsub = null;
var dmUnsub = null;
var notifUnsub = null;
var searchTm = null;
var selectedCat = 'genel';
var likedView = false;

// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SK = 'padfolio_v5';
var SET_K = 'padfolio_settings_v5';
function loadSess(){ try{ return JSON.parse(localStorage.getItem(SK)); } catch(e){ return null; } }
function saveSess(u){ localStorage.setItem(SK, JSON.stringify(u)); }
function clearSess(){ localStorage.removeItem(SK); }
function loadSettings(){ try{ return JSON.parse(localStorage.getItem(SET_K)) || {}; } catch(e){ return {}; } }
function saveSettings(s){ localStorage.setItem(SET_K, JSON.stringify(s)); }
var settings = loadSettings();

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg, type){
  var wrap = document.getElementById('toastWrap');
  if(!wrap){ wrap=document.createElement('div'); wrap.className='toast-wrap'; wrap.id='toastWrap'; document.body.appendChild(wrap); }
  while(wrap.children.length >= 4) wrap.removeChild(wrap.firstChild);
  var t = document.createElement('div');
  t.className = 'toast'+(type?' '+type:'');
  t.innerHTML = '<span>'+msg+'</span>';
  wrap.appendChild(t);
  setTimeout(function(){ t.classList.add('out'); setTimeout(function(){ if(t.parentNode) t.parentNode.removeChild(t); },220); }, 2800);
}
function timeAgo(ts){
  if(!ts) return '';
  var s = Math.floor((Date.now() - (ts.toMillis ? ts.toMillis() : ts)) / 1000);
  if(s < 60) return s+'sn';
  if(s < 3600) return Math.floor(s/60)+'dk';
  if(s < 86400) return Math.floor(s/3600)+'sa';
  return Math.floor(s/86400)+'g';
}
function getCat(id){ return CATS.find(function(c){ return c.id === id; }) || CATS[1]; }
function gradColor(name){
  var i = (name||'?').charCodeAt(0) % GRADS.length;
  return 'linear-gradient(135deg,'+GRADS[i][0]+','+GRADS[i][1]+')';
}
function getAvBg(username, userData){
  var u = userData || allUsers.find(function(x){ return x.username === username; }) || {};
  return u.avColor || (function(){ var i=(username||'?').charCodeAt(0)%GRADS.length; return GRADS[i][0]; })();
}
function getAvEmoji(username, userData){
  var u = userData || allUsers.find(function(x){ return x.username === username; }) || {};
  return u.avEmoji || (username||'?').charAt(0).toUpperCase();
}
function mkAv(username, userData, size, extra){
  var bg = getAvBg(username, userData);
  var em = getAvEmoji(username, userData);
  size = size || 36;
  var fs = size > 50 ? Math.round(size*0.45) : Math.round(size*0.5);
  return '<div class="av" style="width:'+size+'px;height:'+size+'px;font-size:'+fs+'px;background:'+bg+';'+(extra||'')+'" onclick="openProfile(\''+esc(username)+'\')">'+em+'</div>';
}

// â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(){
  if(settings.dark) document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  var t = document.getElementById('darkToggle'); if(t) t.checked = !!settings.dark;
}
function toggleDark(v){ settings.dark = v; saveSettings(settings); applyTheme(); toast(v ? 'Koyu tema ğŸŒ™' : 'AÃ§Ä±k tema â˜€ï¸'); }

function applyFontSize(){
  var fs = settings.fontSize || 14;
  document.documentElement.style.setProperty('--fs', fs+'px');
  var s = document.getElementById('fontSizeSelect'); if(s) s.value = fs;
}
function changeFontSize(v){ settings.fontSize = parseInt(v); saveSettings(settings); applyFontSize(); toast('YazÄ± boyutu gÃ¼ncellendi.'); }

applyTheme();
applyFontSize();

// â”€â”€â”€ GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchGateTab(tab){
  document.querySelectorAll('.gate-tab').forEach(function(b,i){
    b.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register'));
  });
  document.getElementById('gateLogin').classList.toggle('active', tab==='login');
  document.getElementById('gateRegister').classList.toggle('active', tab==='register');
}

function hideGate(){
  document.getElementById('gate').classList.add('gone');
}

function setupGateListeners(){
  document.getElementById('gLoginPass').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('gLoginBtn').click(); });
  document.getElementById('gRegPass').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('gRegBtn').click(); });

  document.getElementById('gLoginBtn').addEventListener('click', async function(){
    if(!db){ toast('BaÄŸlantÄ± kuruluyor, lÃ¼tfen bekle...'); return; }
    var u = document.getElementById('gLoginUser').value.trim();
    var p = document.getElementById('gLoginPass').value;
    var err = document.getElementById('gLoginErr'); err.style.display='none';
    if(!u||!p){ err.textContent='LÃ¼tfen tÃ¼m alanlarÄ± doldur.'; err.style.display='block'; return; }
    try {
      var snap = await getDoc(docRef(db,'users',u));
      var stored = snap.data().password || '';
      // Hash kontrolÃ¼ - hem eski dÃ¼z metin hem yeni SHA-256 destekle
      var hashed = await sha256(p);
      var passOk = (stored === hashed) || (stored === p);
      if(!snap.exists() || !passOk){ err.textContent='KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±.'; err.style.display='block'; return; }
      // Eski dÃ¼z metin ÅŸifreyi hash'e yÃ¼kselt
      if(stored === p && stored !== hashed){
        updateDoc(docRef(db,'users',u),{password:hashed}).catch(function(){});
      }
      currentUser = Object.assign({username:u}, snap.data());
      saveSess(currentUser);
      updateDoc(docRef(db,'users',u), {lastSeen: serverTs()}).catch(function(){});
      hideGate();
      afterLogin();
      toast('HoÅŸ geldin, '+u+'! ğŸ‘‹');
    } catch(e){ err.textContent='BaÄŸlantÄ± hatasÄ±.'; err.style.display='block'; }
  });

  document.getElementById('gRegBtn').addEventListener('click', async function(){
    if(!db){ toast('BaÄŸlantÄ± kuruluyor, lÃ¼tfen bekle...'); return; }
    var u = document.getElementById('gRegUser').value.trim();
    var p = document.getElementById('gRegPass').value;
    var ue = document.getElementById('gRegUserErr');
    var pe = document.getElementById('gRegPassErr');
    ue.style.display = pe.style.display = 'none';
    var ok = true;
    if(!u || u.length<3 || /\s/.test(u)){ ue.style.display='block'; ok=false; }
    if(!p || p.length<6){ pe.style.display='block'; ok=false; }
    if(!ok) return;
    try {
      var snap = await getDoc(docRef(db,'users',u));
      if(snap.exists()){ ue.textContent='Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.'; ue.style.display='block'; return; }
      var hashedPw = await sha256(p);
      await setDoc(docRef(db,'users',u),{
        username:u, password:hashedPw, joinedAt:serverTs(),
        postCount:0, commentCount:0, likeCount:0,
        savedPosts:[], friends:[], friendRequests:[], sentRequests:[],
        isPrivate:false, dmRestrict:false, lastSeen:serverTs(),
        avEmoji:'ğŸ˜Š', avColor: AV_COLORS[Math.floor(Math.random()*8)]
      });
      currentUser = {username:u, password:hashedPw, postCount:0, commentCount:0, likeCount:0, savedPosts:[], friends:[], friendRequests:[], sentRequests:[], avEmoji:'ğŸ˜Š', avColor:AV_COLORS[0]};
      saveSess(currentUser);
      hideGate();
      afterLogin();
      toast('HesabÄ±n oluÅŸturuldu! ğŸ‰');
    } catch(e){ console.error(e); toast('Hata: '+e.message); }
  });
}

// â”€â”€â”€ AFTER LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function afterLogin(){
  renderNav();
  renderMiniProfile();
  renderCats();
  renderComposeCats();
  startListening();
  startNotifListener();
  setTimeout(checkUrlParams,300);
  setTimeout(renderFriendSuggestions,1200);
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNav(){
  var nr = document.getElementById('navRight');
  if(!currentUser){ nr.innerHTML=''; return; }
  nr.innerHTML =
    '<button class="notif-btn" onclick="goNotifs()">ğŸ””<span class="notif-badge hidden" id="notifBadge">0</span></button>'+
    (isAdmin() ? '<button class="nav-btn btn-ghost" onclick="openAdminPanel()" style="background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;font-weight:700;font-size:12px">âš™ï¸ Admin</button>' : '')+
    '<div class="nav-av-wrap" id="navAvWrap" onclick="openMyProfile()" >'+
      mkAv(currentUser.username, currentUser, 30)+
      '<span class="nav-username">@'+esc(currentUser.username)+'</span>'+
    '</div>'+
    '<button class="nav-btn btn-ghost" onclick="goSettings()">âš™ï¸</button>';
}


// â”€â”€â”€ MINI PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMiniProfile(){
  if(!currentUser) return;
  var u = currentUser;
  var mpAv = document.getElementById('mpAv');
  mpAv.textContent = getAvEmoji(u.username, u);
  mpAv.style.background = getAvBg(u.username, u);
  document.getElementById('mpCover').style.background = u.coverGradient || COVER_GRADIENTS[0];
  document.getElementById('mpName').textContent = u.username;
  document.getElementById('mpSub').textContent = '@'+u.username+' Â· Profili GÃ¶r â†’';
  document.getElementById('mpEditBtn').style.display = 'flex';
  document.getElementById('mpPosts').textContent = u.postCount||0;
  document.getElementById('mpComments').textContent = u.commentCount||0;
  document.getElementById('mpLikes').textContent = u.likeCount||0;
  // Durum notu
  var mpStatus = document.getElementById('mpStatus');
  if(mpStatus){
    if(u.statusNote){
      mpStatus.style.display = 'block';
      mpStatus.innerHTML =
        '<div onclick="goSettings()" title="Durumu dÃ¼zenle" style="display:inline-flex;align-items:center;gap:6px;background:var(--surface2);border:1.5px solid var(--border);border-radius:20px;padding:4px 11px;font-size:11px;font-weight:600;color:var(--text);cursor:pointer;max-width:180px;overflow:hidden;transition:border-color .15s" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'
          +'<div style="width:7px;height:7px;background:var(--green);border-radius:50%;flex-shrink:0;animation:pulse 2s infinite"></div>'
          +'<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(u.statusNote)+'</span>'
        +'</div>';
    } else {
      mpStatus.style.display = 'block';
      mpStatus.innerHTML =
        '<div onclick="goSettings()" title="Durum ekle" style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;color:var(--muted);cursor:pointer;border:1.5px dashed var(--border);transition:all .15s" onmouseover="this.style.borderColor=\'var(--accent)\';this.style.color=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--muted)\'">'
          +'<span>ğŸ’¬</span><span>Durum ekle...</span>'
        +'</div>';
    }
  }
}

function goToMyProfile(){ if(currentUser) openProfile(currentUser.username); }

// â”€â”€â”€ CATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCats(){
  document.getElementById('catList').innerHTML = CATS.map(function(c){
    return '<div class="cat-item '+(activeCat===c.id?'active':'')+'" onclick="filterCat(\''+c.id+'\')">'
      +'<div class="cat-ic" style="background:'+c.color+'22">'+c.icon+'</div>'
      +'<span>'+c.label+'</span>'
      +'</div>';
  }).join('');
}

function toggleCatMenu(){
  catMenuOpen = !catMenuOpen;
  var dd = document.getElementById('catDropdown');
  var ic = document.getElementById('catIcon');
  if(catMenuOpen){
    dd.classList.add('open');
    ic.style.transform = 'rotate(-180deg)';
    setTimeout(function(){
      document.addEventListener('click', closeCatOutside);
    }, 10);
  } else {
    dd.classList.remove('open');
    ic.style.transform = '';
    document.removeEventListener('click', closeCatOutside);
  }
}
function closeCatOutside(e){
  var hd = document.getElementById('catHd');
  var dd = document.getElementById('catDropdown');
  if(hd && !hd.contains(e.target) && dd && !dd.contains(e.target)){
    catMenuOpen = false;
    dd.classList.remove('open');
    document.getElementById('catIcon').style.transform = '';
    document.removeEventListener('click', closeCatOutside);
  }
}
function filterCat(id){
  activeCat = id;
  likedView = false;
  renderCats();
  showView('feedView');
  setNavActive('navHome');
  renderFeed();
  catMenuOpen = false;
  document.getElementById('catDropdown').classList.remove('open');
  document.getElementById('catIcon').style.transform = '';
  document.removeEventListener('click', closeCatOutside);
}

function renderComposeCats(){
  document.getElementById('composeCats').innerHTML = CATS.filter(function(c){ return c.id!=='all'; }).map(function(c){
    return '<button class="cat-pill '+(selectedCat===c.id?'selected':'')+'" onclick="selCat(\''+c.id+'\')">'
      +c.icon+' '+c.label+'</button>';
  }).join('');
}
function selCat(id){ selectedCat=id; renderComposeCats(); }
function openCompose(){
  document.getElementById('composeExpanded').classList.add('open');
  document.getElementById('postTitle').focus();
}

// â”€â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var VIEWS = ['feedView','detailView','profileView','friendsView','dmView','settingsView','notifsView','likedView'];
function showView(id){
  VIEWS.forEach(function(v){
    document.getElementById(v).style.display = (v===id) ? 'block' : 'none';
  });
}
function setNavActive(id){
  ['navHome','navLiked','navFriends','navDM'].forEach(function(n){
    var el = document.getElementById(n);
    if(el) el.classList.toggle('active', n===id);
  });
}
function goHome(){
  likedView=false;
  showView('feedView');
  setNavActive('navHome');
  renderFeed();
  if(commentsUnsub){ commentsUnsub(); commentsUnsub=null; }
}
function goLiked(){
  likedView=true;
  showView('likedView');
  setNavActive('navLiked');
  renderLiked();
}
function goFriends(){ if(!currentUser){toast('GiriÅŸ yap!');return;} showView('friendsView'); setNavActive('navFriends'); renderFriendsList(); }
function goDM(){ if(!currentUser){toast('GiriÅŸ yap!');return;} showView('dmView'); setNavActive('navDM'); buildDMConvList(); }
function goSettings(){ if(!currentUser){toast('GiriÅŸ yap!');return;} showView('settingsView'); loadSettingsUI(); }
function goNotifs(){ if(!currentUser){toast('GiriÅŸ yap!');return;} showView('notifsView'); renderNotifs(); }

function loadSettingsUI(){
  var d = document.getElementById('darkToggle'); if(d) d.checked = !!settings.dark;
  var p = document.getElementById('privacyToggle'); if(p) p.checked = !!settings.privateAccount;
  var o = document.getElementById('onlineToggle'); if(o) o.checked = settings.showOnline!==false;
  var dm= document.getElementById('dmRestrictToggle'); if(dm) dm.checked = !!settings.dmRestrict;
  // Bio & status alanlarÄ±nÄ± doldur
  var bioIn = document.getElementById('bioInput');
  var statIn = document.getElementById('statusInput');
  if(currentUser){
    if(bioIn) bioIn.value = currentUser.bio || '';
    if(statIn) statIn.value = currentUser.statusNote || '';
  }
  applyFontSize();
}

async function saveProfileInfo(){
  if(!currentUser) return;
  var bio = (document.getElementById('bioInput')||{}).value||'';
  var statusNote = (document.getElementById('statusInput')||{}).value||'';
  await updateDoc(docRef(db,'users',currentUser.username),{bio:bio.trim(), statusNote:statusNote.trim()});
  currentUser.bio = bio.trim();
  currentUser.statusNote = statusNote.trim();
  saveSess(currentUser);
  renderMiniProfile(); // Sol paneli de gÃ¼ncelle
  toast('Profil bilgileri kaydedildi! âœ¨');
}
function togglePrivacy(v){
  settings.privateAccount = v; saveSettings(settings);
  if(currentUser) updateDoc(docRef(db,'users',currentUser.username),{isPrivate:v}).catch(function(){});
  toast(v ? 'Hesap gizlendi ğŸ”’' : 'Hesap herkese aÃ§Ä±k ğŸŒ');
}
function toggleOnlineStatus(v){ settings.showOnline=v; saveSettings(settings); toast(v?'Ã‡evrimiÃ§i gÃ¶rÃ¼nÃ¼r':'Ã‡evrimiÃ§i gizli'); }
function toggleDmRestrict(v){
  settings.dmRestrict=v; saveSettings(settings);
  if(currentUser) updateDoc(docRef(db,'users',currentUser.username),{dmRestrict:v}).catch(function(){});
  toast(v?'DM yalnÄ±zca arkadaÅŸlara aÃ§Ä±k':'DM herkese aÃ§Ä±k');
}
function doLogout(){
  if(!confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸine emin misin?')) return;
  if(currentUser) updateDoc(docRef(db,'users',currentUser.username),{lastSeen:null}).catch(function(){});
  currentUser=null; clearSess();
  if(notifUnsub){ notifUnsub(); notifUnsub=null; }
  document.getElementById('gate').classList.remove('gone');
  document.getElementById('gLoginUser').value='';
  document.getElementById('gLoginPass').value='';
  toast('Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.');
}

// â”€â”€â”€ DELETE ACCOUNT (ÅŸifre doÄŸrulamalÄ±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteAccount(){
  if(!currentUser) return;
  if(!confirm('âš ï¸ HesabÄ±nÄ± SÄ°LMEK istediÄŸine emin misin?\nBu iÅŸlem GERÄ° ALINAMAZ!')) return;
  var pass = prompt('Silme iÅŸlemini onaylamak iÃ§in ÅŸifreni gir:');
  if(pass === null) return; // kullanÄ±cÄ± iptal etti
  if(pass !== currentUser.password){
    toast('âŒ Åifre hatalÄ±! Hesap silinmedi.');
    return;
  }
  deleteDoc(docRef(db,'users',currentUser.username)).catch(function(){});
  currentUser=null; clearSess();
  if(notifUnsub){ notifUnsub(); notifUnsub=null; }
  document.getElementById('gate').classList.remove('gone');
  toast('HesabÄ±n silindi. ğŸ—‘ï¸');
}

// â”€â”€â”€ AVATAR PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAvModal(){
  if(!currentUser){ toast('GiriÅŸ yap!'); return; }
  pickerEmoji = currentUser.avEmoji || 'ğŸ˜Š';
  pickerColor = currentUser.avColor || '#6366f1';
  renderAvPicker();
  document.getElementById('avModal').classList.remove('hidden');
}
function closeAvModal(){ document.getElementById('avModal').classList.add('hidden'); }
function renderAvPicker(){
  var prev = document.getElementById('avPreview');
  prev.style.background = pickerColor;
  prev.textContent = pickerEmoji;

  document.getElementById('emojiGrid').innerHTML = EMOJIS.map(function(e){
    return '<div class="emoji-opt '+(pickerEmoji===e?'selected':'')+'" onclick="pickEmoji(\''+e+'\')" >'+e+'</div>';
  }).join('');

  document.getElementById('colorGrid').innerHTML = AV_COLORS.map(function(c){
    return '<div class="color-opt '+(pickerColor===c?'selected':'')+'" style="background:'+c+'" onclick="pickColor(\''+c+'\')" ></div>';
  }).join('');
}
function pickEmoji(e){ pickerEmoji=e; renderAvPicker(); }
function pickColor(c){ pickerColor=c; renderAvPicker(); }
async function saveAvatar(){
  if(!currentUser) return;
  await updateDoc(docRef(db,'users',currentUser.username), {avEmoji:pickerEmoji, avColor:pickerColor});
  currentUser.avEmoji = pickerEmoji;
  currentUser.avColor = pickerColor;
  saveSess(currentUser);
  closeAvModal();
  renderNav();
  renderMiniProfile();
  var u = allUsers.find(function(x){ return x.username===currentUser.username; });
  if(u){ u.avEmoji=pickerEmoji; u.avColor=pickerColor; }
  toast('Profil gÃ¼ncellendi! âœ¨');
}

// â”€â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(tab){
  activeTab = tab;
  document.getElementById('tabSon').classList.toggle('active', tab==='son');
  document.getElementById('tabTrend').classList.toggle('active', tab==='trend');
  renderFeed();
}
function onSearch(val){
  clearTimeout(searchTm);
  searchTm = setTimeout(function(){ renderFeed(val.trim()); }, 280);
}

function renderFeed(search){
  search = search || '';
  var posts = allPosts.slice();
  if(activeCat !== 'all') posts = posts.filter(function(p){ return p.cat === activeCat; });
  posts = posts.filter(function(p){
    var u = allUsers.find(function(x){ return x.username===p.author; });
    if(!u || !u.isPrivate) return true;
    if(currentUser && currentUser.username===p.author) return true;
    if(currentUser && (currentUser.friends||[]).indexOf(p.author)>=0) return true;
    return false;
  });
  if(search){
    var q = search.toLowerCase();
    posts = posts.filter(function(p){
      return (p.title||'').toLowerCase().indexOf(q)>=0
          || (p.body||'').toLowerCase().indexOf(q)>=0
          || (p.author||'').toLowerCase().indexOf(q)>=0;
    });
  }
  if(activeTab==='trend'){
    posts.sort(function(a,b){ return ((b.likes||0)+(b.commentCount||0)*2)-((a.likes||0)+(a.commentCount||0)*2); });
  } else {
    posts.sort(function(a,b){
      if(a.pinned && !b.pinned) return -1;
      if(!a.pinned && b.pinned) return 1;
      return (b.ts?b.ts.toMillis():0)-(a.ts?a.ts.toMillis():0);
    });
  }
  var box = document.getElementById('postsContainer');
  if(!posts.length){
    box.innerHTML = search
      ? '<div class="empty"><div class="empty-icon">ğŸ”</div><div style="font-size:14px;font-weight:500">"'+esc(search)+'" iÃ§in sonuÃ§ bulunamadÄ±.</div></div>'
      : '<div class="empty"><div class="empty-icon">ğŸ“­</div><div style="font-size:14px;font-weight:500">Bu kategoride henÃ¼z gÃ¶nderi yok.</div></div>';
    return;
  }
  if(search) box.innerHTML = '<div class="search-result-hd">'+posts.length+' sonuÃ§</div>' + posts.map(function(p){ return postCard(p,search); }).join('');
  else box.innerHTML = posts.map(function(p){ return postCard(p); }).join('');
}

function renderLiked(){
  var box = document.getElementById('likedContainer');
  if(!currentUser){ box.innerHTML='<div class="empty"><div class="empty-icon">ğŸ”’</div><div style="font-size:14px;font-weight:500">GiriÅŸ yap.</div></div>'; return; }
  var posts = allPosts.filter(function(p){ return (p.likedBy||[]).indexOf(currentUser.username)>=0; });
  if(!posts.length){ box.innerHTML='<div class="empty"><div class="empty-icon">â¤ï¸</div><div style="font-size:14px;font-weight:500">HenÃ¼z beÄŸenilen gÃ¶nderi yok.</div></div>'; return; }
  box.innerHTML = posts.map(function(p){ return postCard(p); }).join('');
}

function hl(text, search){
  if(!search) return esc(text);
  var re = new RegExp('('+search.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
  return esc(text).replace(re,'<mark class="search-highlight">$1</mark>');
}

function postCard(p, search){
  var cat = getCat(p.cat);
  var liked = currentUser && (p.likedBy||[]).indexOf(currentUser.username)>=0;
  var isOwn = currentUser && currentUser.username===p.author;
  search = search||'';
  var avBg = getAvBg(p.author);
  var avEm = getAvEmoji(p.author);
  return '<div class="post-card'+(p.pinned?' pinned':'')+'">'
    +(p.pinned?'<div class="pin-badge">ğŸ“Œ SabitlenmiÅŸ</div>':'')
    +'<div class="post-top">'
      +'<div class="av post-av" style="background:'+avBg+';cursor:pointer" onclick="openProfile(\''+esc(p.author)+'\')">'+avEm+'</div>'
      +'<div class="post-meta">'
        +'<div class="post-author" onclick="openProfile(\''+esc(p.author)+'\')">'+esc(p.author)+'</div>'
        +'<div class="post-date">'+timeAgo(p.ts)+' Â· <span style="background:'+cat.color+'18;color:'+cat.color+';padding:1px 7px;border-radius:20px;font-size:10px;font-weight:600">'+cat.icon+' '+cat.label+'</span></div>'
      +'</div>'
      +(isOwn?'<div style="display:flex;gap:4px"><button class="act-mini" onclick="togglePin(\''+p.id+'\','+p.pinned+')">ğŸ“Œ</button><button class="act-mini" onclick="deletePost(\''+p.id+'\')" style="color:var(--red)">ğŸ—‘ï¸</button></div>':'')
      +(!isOwn&&isAdmin()?'<button class="adm-quick-del" data-pid="'+p.id+'" onclick="adminQuickDelPost(this.dataset.pid)">âš™ï¸ Sil</button>':'')
    +'</div>'
    +'<div class="post-body-wrap">'
      +'<div class="post-title" onclick="openPost(\''+p.id+'\')">'+hl(p.title,search)+'</div>'
      +'<div class="post-preview">'+hl(p.body,search)+'</div>'
    +'</div>'
    +'<div class="post-stats">'
      +'<span>â¤ï¸ '+((p.likes||0))+' beÄŸeni</span>'
      +'<span>ğŸ’¬ '+(p.commentCount||0)+' yorum</span>'
    +'</div>'
    +'<div class="post-actions">'
      +'<button class="act'+(liked?' liked':'')+'" onclick="likePost(\''+p.id+'\','+liked+')">'
        +'<svg viewBox="0 0 24 24" fill="'+(liked?'currentColor':'none')+'" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>'
        +(liked?'BeÄŸendin':'BeÄŸen')+'</button>'
      +'<button class="act" title="PaylaÅŸ" data-pid="'+p.id+'" onclick="sharePost(this.dataset.pid)">ğŸ”—</button>'+'<button class="act" onclick="openPost(\''+p.id+'\')">'
        +'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
        +'Yorum Yap</button>'
    +'</div>'
    +'</div>';
}

// â”€â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitPost(){
  if(!currentUser){ toast('Ã–nce giriÅŸ yap!'); return; }
  var title = document.getElementById('postTitle').value.trim();
  var body = document.getElementById('postBody').value.trim();
  if(!title){ toast('BaÅŸlÄ±k gerekli!'); return; }
  if(!body){ toast('Ä°Ã§erik gerekli!'); return; }
  await addDoc(col(db,'posts'),{title:title, body:body, author:currentUser.username, cat:selectedCat, ts:serverTs(), likes:0, commentCount:0, views:0, likedBy:[], pinned:false});
  await updateDoc(docRef(db,'users',currentUser.username),{postCount:incr(1)});
  currentUser.postCount=(currentUser.postCount||0)+1; saveSess(currentUser); renderMiniProfile();
  document.getElementById('postTitle').value='';
  document.getElementById('postBody').value='';
  document.getElementById('composeExpanded').classList.remove('open');
  // Emoji picker sÄ±fÄ±rla
  clearPostEmoji();
  var popup = document.getElementById('emojiPickerPopup');
  if(popup){ popup.classList.remove('open'); emojiPickerOpen=false; }
  sfx('post'); toast('GÃ¶nderi paylaÅŸÄ±ldÄ±! ğŸš€','success');
}

async function likePost(id, alreadyLiked){
  if(!currentUser){ toast('BeÄŸenmek iÃ§in giriÅŸ yap!'); return; }
  var ref = docRef(db,'posts',id);
  var snap = await getDoc(ref); if(!snap.exists()) return;
  sfx(alreadyLiked?'delete':'like');
  if(alreadyLiked){
    await updateDoc(ref, {likes:incr(-1), likedBy:arrRemove(currentUser.username)});
  } else {
    await updateDoc(ref, {likes:incr(1), likedBy:arrUnion(currentUser.username)});
    var author = snap.data().author;
    if(author && author!==currentUser.username){
      updateDoc(docRef(db,'users',author),{likeCount:incr(1)}).catch(function(){});
      addNotif(author,'like',currentUser.username+' gÃ¶nderini beÄŸendi â¤ï¸',id);
    }
  }
}

async function togglePin(id, pinned){
  if(!currentUser) return;
  await updateDoc(docRef(db,'posts',id),{pinned:!pinned});
  toast(pinned?'Sabit kaldÄ±rÄ±ldÄ±.':'Sabitlendi ğŸ“Œ');
}
async function deletePost(id){
  if(!currentUser||!confirm('GÃ¶nderiyi silmek istediÄŸine emin misin?')) return;
  sfx('delete');
  await deleteDoc(docRef(db,'posts',id));
  updateDoc(docRef(db,'users',currentUser.username),{postCount:incr(-1)}).catch(function(){});
  toast('GÃ¶nderi silindi.');
}

// â”€â”€â”€ STORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStories(){
  var seen={}, authors=[];
  allPosts.slice().sort(function(a,b){ return (b.ts?b.ts.toMillis():0)-(a.ts?a.ts.toMillis():0); })
    .forEach(function(p){ if(!seen[p.author]){ seen[p.author]=1; authors.push(p.author); } });
  document.getElementById('storiesRow').innerHTML =
    '<div class="story"><div class="story-ring" style="background:var(--surface2);border:2px dashed var(--border)"><div class="story-av" style="font-size:22px;color:var(--muted)">+</div></div><div class="story-name">Ekle</div></div>'
    + authors.slice(0,8).map(function(a){
        return '<div class="story" onclick="openProfile(\''+esc(a)+'\')"><div class="story-ring"><div class="story-av" style="background:'+getAvBg(a)+'">'+getAvEmoji(a)+'</div></div><div class="story-name">'+esc(a)+'</div></div>';
      }).join('');
}

// â”€â”€â”€ ONLINE / LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOnline(){
  updateOnlineCount();
  var now = Date.now();
  var online = allUsers.filter(function(u){ var ms=u.lastSeen&&u.lastSeen.toMillis?u.lastSeen.toMillis():0; return ms&&(now-ms<180000); }).slice(0,6);
  document.getElementById('onlineCnt').textContent = online.length ? '('+online.length+')' : '';
  document.getElementById('onlineList').innerHTML = online.length
    ? online.map(function(u){
        return '<div class="online-row" onclick="openProfile(\''+esc(u.username)+'\')">'
          +'<div style="position:relative;display:inline-block">'
            +'<div class="av" style="width:30px;height:30px;font-size:14px;background:'+getAvBg(u.username,u)+'">'+getAvEmoji(u.username,u)+'</div>'
            +'<div style="position:absolute;bottom:0;right:0;width:9px;height:9px;background:var(--green);border-radius:50%;border:2px solid var(--surface)"></div>'
          +'</div>'
          +'<div class="online-name">'+esc(u.username)+'</div>'
          +'<div class="online-time">'+timeAgo(u.lastSeen)+'</div>'
          +'</div>';
      }).join('')
    : '<div style="padding:12px;font-size:12px;color:var(--muted)">Åu an kimse Ã§evrimiÃ§i deÄŸil.</div>';
}
function renderLeaderboard(){
  var sorted = allUsers.filter(function(u){ return u.showOnLeaderboard!==false; }).slice().sort(function(a,b){
    return ((b.postCount||0)*3+(b.likeCount||0)*2+(b.commentCount||0)) - ((a.postCount||0)*3+(a.likeCount||0)*2+(a.commentCount||0));
  }).slice(0,5);
  var medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'];
  var cls=['gold','silver','bronze','',''];
  document.getElementById('leaderboard').innerHTML = sorted.length
    ? sorted.map(function(u,i){
        return '<div class="lb-row" onclick="openProfile(\''+esc(u.username)+'\')">'
          +'<div class="lb-rank '+cls[i]+'">'+medals[i]+'</div>'
          +'<div class="av" style="width:34px;height:34px;font-size:16px;background:'+getAvBg(u.username,u)+'">'+getAvEmoji(u.username,u)+'</div>'
          +'<div class="lb-info"><div class="lb-name">'+esc(u.username)+'</div><div class="lb-score">ğŸ“ '+(u.postCount||0)+' Â· â¤ï¸ '+(u.likeCount||0)+' Â· ğŸ’¬ '+(u.commentCount||0)+'</div></div>'
          +'</div>';
      }).join('')
    : '<div style="padding:14px;font-size:12px;color:var(--muted)">HenÃ¼z kullanÄ±cÄ± yok.</div>';
}

// â”€â”€â”€ OPEN POST / DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openPost(id){
  showView('detailView');
  document.getElementById('detailContent').innerHTML='<div class="skeleton" style="height:220px"></div>';
  updateDoc(docRef(db,'posts',id),{views:incr(1)}).catch(function(){});
  var snap = await getDoc(docRef(db,'posts',id)); if(!snap.exists()) return;
  var p = Object.assign({id:snap.id}, snap.data());
  var cat = getCat(p.cat);
  var liked = currentUser && (p.likedBy||[]).indexOf(currentUser.username)>=0;
  var isOwn = currentUser && currentUser.username===p.author;
  document.getElementById('detailContent').innerHTML =
    '<div class="detail-card">'
      +'<div class="post-top" style="padding:14px 16px 10px">'
        +'<div class="av post-av" style="background:'+getAvBg(p.author)+';cursor:pointer" onclick="openProfile(\''+esc(p.author)+'\')">'+getAvEmoji(p.author)+'</div>'
        +'<div class="post-meta">'
          +'<div class="post-author" onclick="openProfile(\''+esc(p.author)+'\')">'+esc(p.author)+'</div>'
          +'<div class="post-date">'+timeAgo(p.ts)+' Â· <span style="background:'+cat.color+'18;color:'+cat.color+';padding:1px 7px;border-radius:20px;font-size:10px;font-weight:600">'+cat.icon+' '+cat.label+'</span></div>'
        +'</div>'
      +'</div>'
      +'<div style="padding:0 16px 14px">'
        +'<div class="detail-title">'+esc(p.title)+'</div>'
        +'<div class="detail-body">'+esc(p.body)+'</div>'
      +'</div>'
      +'<div class="post-stats" style="border-top:1px solid var(--border)"><span>â¤ï¸ '+(p.likes||0)+' beÄŸeni</span><span>ğŸ’¬ '+(p.commentCount||0)+' yorum</span></div>'
      +'<div class="post-actions">'
        +'<button class="act'+(liked?' liked':'')+'" onclick="likePost(\''+p.id+'\','+liked+');setTimeout(function(){openPost(\''+p.id+'\');},500)">'
          +'<svg viewBox="0 0 24 24" fill="'+(liked?'currentColor':'none')+'" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>'
          +(liked?'BeÄŸendin':'BeÄŸen')+'</button>'
        +(isOwn?'<button class="act" onclick="deletePost(\''+p.id+'\');goHome()" style="color:var(--red)">ğŸ—‘ï¸ Sil</button>':'')
      +'</div>'
    +'</div>'
    +'<div class="comments-card">'
      +'<div class="comments-hd">ğŸ’¬ Yorumlar ('+(p.commentCount||0)+')</div>'
      +'<div class="comments-body">'
        +(currentUser
          ? '<div class="comment-compose"><div class="av" style="width:30px;height:30px;font-size:14px;background:'+getAvBg(currentUser.username,currentUser)+'">'+getAvEmoji(currentUser.username,currentUser)+'</div><textarea class="comment-ta" id="commentInput" placeholder="Yorumunu yaz..."></textarea><button class="comment-send" onclick="sendComment(\''+p.id+'\',\''+esc(p.author)+'\')">GÃ¶nder</button></div>'
          : '<div style="font-size:13px;color:var(--muted);margin-bottom:14px">Yorum yapmak iÃ§in giriÅŸ yap.</div>')
        +'<div id="commentsList"><div class="loading"><div class="ld"></div><div class="ld"></div><div class="ld"></div></div></div>'
      +'</div>'
    +'</div>';
  listenComments(id);
}

function listenComments(postId){
  if(commentsUnsub){ commentsUnsub(); commentsUnsub=null; }
  var q = qry(col(db,'posts',postId,'comments'), orderBy('ts','asc'), lmt(60));
  commentsUnsub = onSnapshot(q, function(snap){
    var box = document.getElementById('commentsList'); if(!box) return;
    var comments = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    if(!comments.length){ box.innerHTML='<div style="text-align:center;color:var(--muted);font-size:13px;padding:16px">HenÃ¼z yorum yok!</div>'; return; }
    box.innerHTML = comments.map(function(c){
      return '<div class="comment">'
        +'<div class="av" style="width:30px;height:30px;font-size:13px;background:'+getAvBg(c.author)+'">'+getAvEmoji(c.author)+'</div>'
        +'<div class="comment-right"><div class="comment-bubble">'
          +'<div class="comment-author" onclick="openProfile(\''+esc(c.author)+'\')">'+esc(c.author)+'</div>'
          +'<div class="comment-text">'+esc(c.text)+'</div>'
        +'</div><div class="comment-date">'+timeAgo(c.ts)+'</div></div>'
        +'</div>';
    }).join('');
  });
}
async function sendComment(postId, postAuthor){
  if(!currentUser) return;
  if(!checkRateLimit()) return;
  var ta = document.getElementById('commentInput');
  var text = ta.value.trim(); if(!text) return;
  ta.value='';
  await addDoc(col(db,'posts',postId,'comments'),{author:currentUser.username, text:text, ts:serverTs()});
  await updateDoc(docRef(db,'posts',postId),{commentCount:incr(1)});
  updateDoc(docRef(db,'users',currentUser.username),{commentCount:incr(1)}).catch(function(){});
  if(postAuthor && postAuthor!==currentUser.username)
    addNotif(postAuthor,'comment',currentUser.username+' gÃ¶nderine yorum yaptÄ± ğŸ’¬',postId);
}

// â”€â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openProfile(username){
  showView('profileView');
  trackProfileVisit(username);
  document.getElementById('profileContent').innerHTML='<div class="skeleton" style="height:200px"></div>';
  if(currentUser){
    var mySnap = await getDoc(docRef(db,'users',currentUser.username));
    if(mySnap.exists()){
      var d=mySnap.data();
      currentUser.friends=d.friends||[]; currentUser.friendRequests=d.friendRequests||[]; currentUser.sentRequests=d.sentRequests||[];
      saveSess(currentUser);
    }
  }
  var snap = await getDoc(docRef(db,'users',username));
  var data = snap.exists() ? snap.data() : {postCount:0,commentCount:0,likeCount:0};
  var isOwnProfile = currentUser && currentUser.username===username;
  var isFriend = currentUser && (currentUser.friends||[]).indexOf(username)>=0;
  var canSee = !data.isPrivate || isOwnProfile || isFriend;
  var userPosts = canSee ? allPosts.filter(function(p){ return p.author===username; }).sort(function(a,b){ return (b.ts?b.ts.toMillis():0)-(a.ts?a.ts.toMillis():0); }).slice(0,12) : [];
  var joinDate = data.joinedAt ? new Date(data.joinedAt.toMillis?data.joinedAt.toMillis():data.joinedAt).toLocaleDateString('tr-TR') : 'â€”';
  var friendCount = (data.friends||[]).length;
  var avBg = data.avColor || getAvBg(username);
  var avEm = data.avEmoji || getAvEmoji(username);

  var fbHtml = '';
  if(!isOwnProfile && currentUser){
    var status = getFriendStatus(username);
    // DM butonu: arkadaÅŸsa her zaman, deÄŸilse sadece dmRestrict kapalÄ±ysa gÃ¶ster
    var canDM = status==='friends' || !data.dmRestrict;
    if(status==='friends') fbHtml='<button class="friend-btn friends" onclick="removeFriend(\''+esc(username)+'\')">âœ… ArkadaÅŸsÄ±nÄ±z</button> <button class="dm-btn" onclick="openDMWith(\''+esc(username)+'\')">ğŸ’¬ Mesaj</button>';
    else if(status==='pending') fbHtml='<button class="friend-btn pending" disabled>â³ Ä°stek GÃ¶nderildi</button>'+(canDM?' <button class="dm-btn" onclick="openDMWith(\''+esc(username)+'\')">ğŸ’¬ Mesaj</button>':'');
    else if(status==='incoming') fbHtml='<button class="friend-btn accept" onclick="acceptFriendRequest(\''+esc(username)+'\')">âœ… Kabul Et</button>'+(canDM?' <button class="dm-btn" onclick="openDMWith(\''+esc(username)+'\')">ğŸ’¬ Mesaj</button>':'');
    else fbHtml='<button class="friend-btn add" onclick="sendFriendRequest(\''+esc(username)+'\')">â• ArkadaÅŸ Ekle</button>'+(canDM?' <button class="dm-btn" onclick="openDMWith(\''+esc(username)+'\')">ğŸ’¬ Mesaj</button>':'<button class="dm-btn" style="opacity:.5;cursor:not-allowed" title="Bu kullanÄ±cÄ± DM\'leri kÄ±sÄ±tladÄ±" disabled>ğŸ”’ Mesaj</button>');
  }

  document.getElementById('profileContent').innerHTML =
    '<div class="card" style="margin-bottom:12px;overflow:visible">'
      +'<div class="profile-cover" style="background:'+(data.coverGradient||COVER_GRADIENTS[0])+'"></div>'
      +'<div class="profile-av-area">'
        +'<div class="av profile-av" style="width:64px;height:64px;font-size:30px;background:'+avBg+';border:4px solid var(--surface)">'+avEm+'</div>'
        +(isOwnProfile?'<div class="profile-edit-btn" onclick="openAvModal()">âœï¸</div>':'')
      +'</div>'
      +'<div class="profile-info">'
        +'<div><div class="profile-name">@'+esc(username)+(data.isPrivate?' ğŸ”’':'')+'</div><div class="profile-join">KatÄ±lÄ±m: '+joinDate+'</div></div>'
        +(fbHtml||'')
        +(isOwnProfile?'<button class="dm-btn" onclick="goSettings()">âš™ï¸ Ayarlar</button> <button class="dm-btn" onclick="openCoverModal()" style="background:var(--surface2)">ğŸ¨ Kapak</button>':'')
      +(!isOwnProfile&&currentUser?'<button style="padding:5px 11px;border:1.5px solid #ef4444;border-radius:8px;font-size:12px;color:#ef4444;background:none;cursor:pointer" data-uid="'+esc(username)+'" onclick="openReportModal(\'user\',this.dataset.uid)">ğŸš©</button>':'')
      +'</div>'
      +(data.statusNote?'<div class="profile-status-note"><div class="profile-status-dot"></div><span>'+esc(data.statusNote)+'</span></div>':'')
      +(data.bio?'<div class="profile-bio">'+esc(data.bio)+'</div>':'')
      +(canSee?'<div class="stats-grid">'
        +'<div class="stat-box"><div class="stat-num">'+(data.postCount||0)+'</div><div class="stat-label">GÃ¶nderi</div></div>'
        +'<div class="stat-box"><div class="stat-num">'+(data.profileViews||0)+'</div><div class="stat-label">ğŸ‘ï¸ Ziyaret</div></div>'
        +'<div class="stat-box"><div class="stat-num">'+(data.commentCount||0)+'</div><div class="stat-label">Yorum</div></div>'
        +'<div class="stat-box"><div class="stat-num">'+(data.likeCount||0)+'</div><div class="stat-label">BeÄŸeni</div></div>'
        +'<div class="stat-box"><div class="stat-num">'+friendCount+'</div><div class="stat-label">ArkadaÅŸ</div></div>'
        +'</div>':'')
    +'</div>'
    +(canSee
      ? '<div style="font-size:14px;font-weight:700;margin-bottom:10px">Son GÃ¶nderiler</div>'
        +(userPosts.length ? userPosts.map(function(p){ return postCard(p); }).join('') : '<div class="empty"><div class="empty-icon">ğŸ“­</div><div style="font-size:14px;font-weight:500">HenÃ¼z gÃ¶nderi yok.</div></div>')
      : '<div class="card"><div style="padding:32px;text-align:center;color:var(--muted)"><div style="font-size:36px;margin-bottom:10px">ğŸ”’</div><div style="font-size:14px;font-weight:600">Bu hesap gizli.</div></div></div>');
}

// â”€â”€â”€ FRIEND SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFriendStatus(username){
  if(!currentUser||currentUser.username===username) return 'self';
  if((currentUser.friends||[]).indexOf(username)>=0) return 'friends';
  if((currentUser.sentRequests||[]).indexOf(username)>=0) return 'pending';
  if((currentUser.friendRequests||[]).indexOf(username)>=0) return 'incoming';
  return 'none';
}
async function sendFriendRequest(toUsername){
  if(!currentUser){ toast('GiriÅŸ yap!'); return; }
  await updateDoc(docRef(db,'users',toUsername),{friendRequests:arrUnion(currentUser.username)});
  await updateDoc(docRef(db,'users',currentUser.username),{sentRequests:arrUnion(toUsername)});
  currentUser.sentRequests=(currentUser.sentRequests||[]).concat([toUsername]); saveSess(currentUser);
  addNotif(toUsername,'friend',currentUser.username+' sana arkadaÅŸlÄ±k isteÄŸi gÃ¶nderdi ğŸ¤');
  sfx('success'); toast('ArkadaÅŸlÄ±k isteÄŸi gÃ¶nderildi! ğŸ¤');
  openProfile(toUsername);
}
async function acceptFriendRequest(fromUsername){
  if(!currentUser) return;
  await updateDoc(docRef(db,'users',currentUser.username),{friends:arrUnion(fromUsername),friendRequests:arrRemove(fromUsername)});
  await updateDoc(docRef(db,'users',fromUsername),{friends:arrUnion(currentUser.username),sentRequests:arrRemove(currentUser.username)});
  currentUser.friends=(currentUser.friends||[]).concat([fromUsername]);
  currentUser.friendRequests=(currentUser.friendRequests||[]).filter(function(r){ return r!==fromUsername; });
  saveSess(currentUser);
  addNotif(fromUsername,'friend',currentUser.username+' arkadaÅŸlÄ±k isteÄŸini kabul etti ğŸ‰');
  toast(fromUsername+' artÄ±k arkadaÅŸÄ±n! ğŸ‰');
  renderFriendsList();
}
async function rejectFriendRequest(fromUsername){
  await updateDoc(docRef(db,'users',currentUser.username),{friendRequests:arrRemove(fromUsername)});
  await updateDoc(docRef(db,'users',fromUsername),{sentRequests:arrRemove(currentUser.username)});
  currentUser.friendRequests=(currentUser.friendRequests||[]).filter(function(r){ return r!==fromUsername; }); saveSess(currentUser);
  toast('Ä°stek reddedildi.'); renderFriendsList();
}
async function removeFriend(username){
  if(!currentUser||!confirm(username+' ile arkadaÅŸlÄ±ÄŸÄ± bitirmek?')) return;
  await updateDoc(docRef(db,'users',currentUser.username),{friends:arrRemove(username)});
  await updateDoc(docRef(db,'users',username),{friends:arrRemove(currentUser.username)});
  currentUser.friends=(currentUser.friends||[]).filter(function(f){ return f!==username; }); saveSess(currentUser);
  toast('ArkadaÅŸlÄ±ktan Ã§Ä±karÄ±ldÄ±.'); renderFriendsList();
}

function switchFTab(tab){
  activeFTab=tab;
  ['Friends','Requests','Sent'].forEach(function(t){
    document.getElementById('ftab'+t).classList.toggle('active', tab===t.toLowerCase());
  });
  renderFriendsList();
}
function renderFriendsList(){
  var box = document.getElementById('friendsListBox');
  if(!currentUser){ box.innerHTML='<div style="padding:20px;text-align:center;color:var(--muted)">GiriÅŸ yap.</div>'; return; }
  var friends=currentUser.friends||[], requests=currentUser.friendRequests||[], sent=currentUser.sentRequests||[];
  document.getElementById('reqBadge').textContent = requests.length ? '('+requests.length+')' : '';
  if(activeFTab==='friends'){
    if(!friends.length){ box.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted)"><div style="font-size:32px">ğŸ‘¥</div>HenÃ¼z arkadaÅŸÄ±n yok.</div>'; return; }
    box.innerHTML=friends.map(function(f){
      var u=allUsers.find(function(x){ return x.username===f; })||{username:f};
      return '<div class="friend-row">'
        +'<div class="av" style="width:40px;height:40px;font-size:18px;background:'+getAvBg(f,u)+';cursor:pointer" onclick="openProfile(\''+esc(f)+'\')">'+getAvEmoji(f,u)+'</div>'
        +'<div style="flex:1"><div class="friend-row-name" onclick="openProfile(\''+esc(f)+'\')">'+esc(f)+'</div><div class="friend-row-sub">'+(u.postCount||0)+' gÃ¶nderi</div></div>'
        +'<div class="fr-actions"><button class="dm-btn" onclick="openDMWith(\''+esc(f)+'\')">ğŸ’¬</button><button class="fr-reject" onclick="removeFriend(\''+esc(f)+'\')">Ã‡Ä±kar</button></div>'
        +'</div>';
    }).join('');
  } else if(activeFTab==='requests'){
    if(!requests.length){ box.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted)"><div style="font-size:32px">ğŸ“­</div>Bekleyen istek yok.</div>'; return; }
    box.innerHTML=requests.map(function(f){
      return '<div class="friend-row">'
        +'<div class="av" style="width:40px;height:40px;font-size:18px;background:'+getAvBg(f)+';cursor:pointer" onclick="openProfile(\''+esc(f)+'\')">'+getAvEmoji(f)+'</div>'
        +'<div style="flex:1"><div class="friend-row-name" onclick="openProfile(\''+esc(f)+'\')">'+esc(f)+'</div><div class="friend-row-sub">ArkadaÅŸlÄ±k isteÄŸi gÃ¶nderdi</div></div>'
        +'<div class="fr-actions"><button class="fr-accept" onclick="acceptFriendRequest(\''+esc(f)+'\')">Kabul Et</button><button class="fr-reject" onclick="rejectFriendRequest(\''+esc(f)+'\')">Reddet</button></div>'
        +'</div>';
    }).join('');
  } else {
    if(!sent.length){ box.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted)"><div style="font-size:32px">ğŸ“¤</div>GÃ¶nderilmiÅŸ istek yok.</div>'; return; }
    box.innerHTML=sent.map(function(f){
      return '<div class="friend-row">'
        +'<div class="av" style="width:40px;height:40px;font-size:18px;background:'+getAvBg(f)+';cursor:pointer" onclick="openProfile(\''+esc(f)+'\')">'+getAvEmoji(f)+'</div>'
        +'<div style="flex:1"><div class="friend-row-name" onclick="openProfile(\''+esc(f)+'\')">'+esc(f)+'</div><div class="friend-row-sub">Cevap bekleniyor...</div></div>'
        +'</div>';
    }).join('');
  }
}

// â”€â”€â”€ DM & GRUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDMId(a,b){ return [a,b].sort().join('__'); }
function openDMWith(username){ goDM(); setTimeout(function(){ openDMChat(username); }, 80); }

// â”€â”€â”€ GRUP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var groupSelectedMembers = [];
var groupModalMode = 'create'; // 'create' | 'addMember'
var groupModalTargetId = null;
var GROUP_EMOJIS = ['ğŸ‘¥','ğŸ®','ğŸ“š','ğŸµ','ğŸ’»','ğŸ†','ğŸ¨','ğŸ•','âš½','ğŸŒŸ','ğŸ”¥','ğŸ’¬','ğŸ¯','ğŸš€','â¤ï¸','ğŸ‰','ğŸ¤','ğŸ’¡','ğŸ ','ğŸ­'];
var groupEmojiIdx = 0;



function openGroupModal(){
  if(!currentUser){ toast('GiriÅŸ yap!'); return; }
  groupModalMode = 'create';
  groupModalTargetId = null;
  groupSelectedMembers = [];
  groupEmojiIdx = 0;
  var title = document.getElementById('groupModalTitle');
  var nameArea = document.getElementById('groupNameArea');
  var actionBtn = document.getElementById('groupActionBtn');
  var emojiBtn = document.getElementById('groupEmojiBtn');
  if(title) title.innerHTML = 'ğŸ‘¥ Grup OluÅŸtur <button class="modal-close" onclick="closeGroupModal()">âœ•</button>';
  if(nameArea) nameArea.style.display = 'block';
  if(actionBtn){ actionBtn.textContent = 'ğŸš€ Grubu OluÅŸtur'; actionBtn.onclick = createGroup; }
  if(emojiBtn) emojiBtn.textContent = 'ğŸ‘¥';
  var nameInput = document.getElementById('groupNameInput');
  if(nameInput) nameInput.value = '';
  renderGroupMembers(currentUser.friends||[], []);
  document.getElementById('groupModal').classList.remove('hidden');
}

function openAddMemberModal(groupId){
  if(!currentUser){ toast('GiriÅŸ yap!'); return; }
  groupModalMode = 'addMember';
  groupModalTargetId = groupId;
  groupSelectedMembers = [];
  var grp = dmGroupCache.find(function(g){ return g.id===groupId; })||{members:[]};
  var title = document.getElementById('groupModalTitle');
  var nameArea = document.getElementById('groupNameArea');
  var actionBtn = document.getElementById('groupActionBtn');
  if(title) title.innerHTML = 'â• Ãœye Ekle <button class="modal-close" onclick="closeGroupModal()">âœ•</button>';
  if(nameArea) nameArea.style.display = 'none';
  if(actionBtn){ actionBtn.textContent = 'â• Ãœye Ekle'; actionBtn.onclick = addMembersToGroup; }
  renderGroupMembers(currentUser.friends||[], grp.members||[]);
  document.getElementById('groupModal').classList.remove('hidden');
}

function closeGroupModal(){
  document.getElementById('groupModal').classList.add('hidden');
}

function renderGroupMembers(friends, excludeList){
  var chips = document.getElementById('groupSelectedChips');
  var countLabel = document.getElementById('groupMemberCountLabel');
  if(chips) chips.innerHTML = '<span style="font-size:12px;color:var(--muted)">HenÃ¼z kimse seÃ§ilmedi</span>';
  groupSelectedMembers = [];
  var available = friends.filter(function(f){ return excludeList.indexOf(f) < 0; });
  var list = document.getElementById('groupMemberList');
  if(!list) return;
  if(!available.length){
    list.innerHTML = '<div style="padding:12px;font-size:12px;color:var(--muted);text-align:center">Eklenebilecek arkadaÅŸ yok</div>';
    return;
  }
  list.innerHTML = available.map(function(f){
    var u = allUsers.find(function(x){ return x.username===f; })||{username:f};
    return '<div class="group-member-item" id="gmi_'+f+'" data-username="'+esc(f)+'" onclick="toggleGroupMember(this.dataset.username)">'
      +'<div class="group-check" id="gmc_'+f+'"></div>'
      +'<div class="av" style="width:28px;height:28px;font-size:13px;background:'+getAvBg(f,u)+'">'+getAvEmoji(f,u)+'</div>'
      +'<span style="font-size:13px;font-weight:600">'+esc(f)+'</span>'
      +'</div>';
  }).join('');
}

function toggleGroupMember(username){
  if(!username) return;
  var idx = groupSelectedMembers.indexOf(username);
  var item = document.getElementById('gmi_'+username);
  var check = document.getElementById('gmc_'+username);
  if(idx >= 0){
    groupSelectedMembers.splice(idx, 1);
    if(item){ item.classList.remove('selected'); }
    if(check){ check.textContent=''; check.style.background=''; check.style.borderColor=''; check.style.color=''; }
  } else {
    groupSelectedMembers.push(username);
    if(item){ item.classList.add('selected'); }
    if(check){ check.textContent='âœ“'; check.style.background='var(--accent)'; check.style.borderColor='var(--accent)'; check.style.color='#fff'; }
  }
  // Count label
  var cl = document.getElementById('groupMemberCountLabel');
  if(cl) cl.textContent = groupSelectedMembers.length ? '('+groupSelectedMembers.length+' seÃ§ildi)' : '';
  // Chips
  var chips = document.getElementById('groupSelectedChips');
  if(!chips) return;
  if(!groupSelectedMembers.length){
    chips.innerHTML = '<span style="font-size:12px;color:var(--muted)">HenÃ¼z kimse seÃ§ilmedi</span>';
  } else {
    chips.innerHTML = groupSelectedMembers.map(function(m){
      return '<span class="group-chip">'+esc(m)+
        '<span style="cursor:pointer;margin-left:4px;font-weight:700;opacity:.7" data-u="'+esc(m)+'" onclick="toggleGroupMember(this.dataset.u)"> Ã—</span></span>';
    }).join('');
  }
}

async function createGroup(){
  if(!currentUser) return;
  var name = document.getElementById('groupNameInput').value.trim();
  if(!name){ toast('Grup adÄ± gerekli!'); return; }
  if(groupSelectedMembers.length < 1){ toast('En az 1 Ã¼ye seÃ§!'); return; }
  var icon = document.getElementById('groupEmojiBtn') ? document.getElementById('groupEmojiBtn').textContent : 'ğŸ‘¥';
  var members = [currentUser.username].concat(groupSelectedMembers);
  var btn = document.getElementById('groupActionBtn');
  if(btn){ btn.disabled = true; btn.textContent = 'OluÅŸturuluyor...'; }
  try {
    var groupRef = await addDoc(col(db,'groups'),{
      name: name, icon: icon, createdBy: currentUser.username,
      members: members, createdAt: serverTs(), lastMsg: '', lastTs: serverTs()
    });
    closeGroupModal();
    sfx('success'); toast('Grup oluÅŸturuldu! ğŸ‰','success');
    await buildDMConvList();
    openGroupChat(groupRef.id, name, members, icon);
  } catch(e){ toast('Hata: '+e.message); }
  if(btn){ btn.disabled = false; btn.textContent = 'ğŸš€ Grubu OluÅŸtur'; }
}

async function addMembersToGroup(){
  if(!currentUser || !groupModalTargetId) return;
  if(!groupSelectedMembers.length){ toast('En az 1 Ã¼ye seÃ§!'); return; }
  var btn = document.getElementById('groupActionBtn');
  if(btn){ btn.disabled = true; btn.textContent = 'Ekleniyor...'; }
  try {
    var updateData = {members: arrUnion.apply(null, groupSelectedMembers)};
    await updateDoc(docRef(db,'groups',groupModalTargetId), updateData);
    toast(groupSelectedMembers.length+' Ã¼ye eklendi! ğŸ‰');
    closeGroupModal();
    await buildDMConvList();
  } catch(e){ toast('Hata: '+e.message); }
  if(btn){ btn.disabled = false; btn.textContent = 'â• Ãœye Ekle'; }
}

// â”€â”€â”€ DM & GRUP LÄ°STE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var dmConvCache = [];
var dmGroupCache = [];
var activeGroupId = null;
var dmUnsub = null;
var activeDmUser = null;

async function buildDMConvList(){
  if(!currentUser) return;
  var friends = currentUser.friends||[];
  var extras = [];
  try {
    var convSnap = await getDocs(col(db,'dms'));
    convSnap.forEach(function(d){
      var parts = d.id.split('__');
      if(parts.indexOf(currentUser.username)>=0){
        var other = parts.find(function(p){ return p!==currentUser.username; });
        if(other && friends.indexOf(other)<0 && extras.indexOf(other)<0) extras.push(other);
      }
    });
  } catch(e){}
  dmConvCache = friends.concat(extras);
  dmGroupCache = [];
  try {
    var grpSnap = await getDocs(col(db,'groups'));
    grpSnap.forEach(function(d){
      var g = Object.assign({id:d.id}, d.data());
      if((g.members||[]).indexOf(currentUser.username)>=0) dmGroupCache.push(g);
    });
    dmGroupCache.sort(function(a,b){
      return (b.lastTs&&b.lastTs.toMillis?b.lastTs.toMillis():0)-(a.lastTs&&a.lastTs.toMillis?a.lastTs.toMillis():0);
    });
  } catch(e){ console.error(e); }
  renderDMConvList();
}

function renderDMConvList(){
  if(!currentUser) return;
  var html = '';
  if(dmGroupCache.length){
    html += '<div class="dm-section-label">Gruplar</div>';
    html += dmGroupCache.map(function(g){
      var isActive = activeGroupId === g.id;
      return '<div class="dm-conv'+(isActive?' active':'')+'" data-gid="'+g.id+'" onclick="openGroupChatById(this.dataset.gid)">'
        +'<div class="group-icon">'+esc(g.icon||'ğŸ‘¥')+'</div>'
        +'<div style="overflow:hidden"><div class="dm-conv-name">'+esc(g.name)+'</div>'
        +'<div class="dm-conv-preview">'+(g.lastMsg?esc(g.lastMsg.substring(0,30)):(g.members.length+' Ã¼ye'))+'</div></div>'
        +'</div>';
    }).join('');
  }
  if(dmConvCache.length){
    html += '<div class="dm-section-label">Direkt Mesajlar</div>';
    html += dmConvCache.map(function(f){
      var isFriend = (currentUser.friends||[]).indexOf(f)>=0;
      return '<div class="dm-conv'+(activeDmUser===f&&!activeGroupId?' active':'')+'" data-user="'+esc(f)+'" onclick="openDMChat(this.dataset.user)">'
        +'<div style="position:relative;display:inline-block">'
          +'<div class="av" style="width:32px;height:32px;font-size:14px;background:'+getAvBg(f)+'">'+getAvEmoji(f)+'</div>'
          +(isFriend?'':'<div style="position:absolute;bottom:-1px;right:-1px;font-size:8px;background:var(--surface2);border-radius:50%;width:13px;height:13px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)">?</div>')
        +'</div>'
        +'<div><div class="dm-conv-name">'+esc(f)+'</div>'
        +'<div class="dm-conv-preview">'+(isFriend?'ArkadaÅŸ':'Mesaj')+'</div></div>'
        +'</div>';
    }).join('');
  }
  if(!html) html = '<div style="padding:14px;font-size:12px;color:var(--muted)">HenÃ¼z mesaj yok.<br>Grup oluÅŸtur veya profillere gidip mesaj at!</div>';
  document.getElementById('dmConvList').innerHTML = html;
}

function openGroupChatById(groupId){
  var g = dmGroupCache.find(function(x){ return x.id===groupId; });
  if(g) openGroupChat(g.id, g.name, g.members, g.icon);
}

function openGroupChat(groupId, groupName, members, icon){
  activeGroupId = groupId;
  activeDmUser = null;
  renderDMConvList();
  if(dmUnsub){ dmUnsub(); dmUnsub=null; }
  var membersArr = Array.isArray(members) ? members : [];
  var grpIcon = icon || 'ğŸ‘¥';
  document.getElementById('dmChat').innerHTML =
    '<div class="dm-chat-hd">'
      +'<div class="group-icon" style="width:28px;height:28px;font-size:14px;border-radius:8px">'+esc(grpIcon)+'</div>'
      +'<div style="flex:1"><div style="font-weight:600">'+esc(groupName)+'</div>'
        +'<div style="font-size:10px;color:var(--muted)">'+membersArr.length+' Ã¼ye</div></div>'
      +'<button data-gid="'+groupId+'" onclick="showGroupInfo(this.dataset.gid)" style="padding:4px 9px;border:1.5px solid var(--border);border-radius:8px;font-size:11px;background:none;color:var(--muted);cursor:pointer">â“˜ Bilgi</button>'
      +'<button class="dm-del-btn" data-gid="'+groupId+'" onclick="deleteGroupChatForMe(this.dataset.gid)">ğŸ—‘ï¸</button>'
    +'</div>'
    +'<div class="dm-messages" id="dmMessages"><div class="dm-empty"><div style="font-size:30px">ğŸ‘¥</div><div>Grup sohbetine hoÅŸ geldin!</div></div></div>'
    +'<div class="dm-input-area">'
      +'<input class="dm-input" id="dmInput" placeholder="Mesaj yaz..." />'
      +'<button class="dm-send" id="dmSendBtn">GÃ¶nder</button>'
    +'</div>';

  // Event listeners for input
  var dmInp = document.getElementById('dmInput');
  var dmSnd = document.getElementById('dmSendBtn');
  var _gid = groupId;
  if(dmInp) dmInp.addEventListener('keydown', function(e){ if(e.key==='Enter') sendGroupMessage(_gid); });
  if(dmSnd) dmSnd.addEventListener('click', function(){ sendGroupMessage(_gid); });

  var q = qry(col(db,'groups',groupId,'messages'), orderBy('ts','asc'), lmt(100));
  dmUnsub = onSnapshot(q, function(snap){
    var msgs = snap.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
    var box = document.getElementById('dmMessages'); if(!box) return;
    if(!msgs.length){
      box.innerHTML='<div class="dm-empty"><div style="font-size:30px">ğŸ‘¥</div><div>Ä°lk mesajÄ± sen at!</div></div>';
      return;
    }
    var prevLen = box.querySelectorAll('.dm-msg').length;
    box.innerHTML = msgs.map(function(m){
      var mine = m.from===currentUser.username;
      return '<div class="dm-msg'+(mine?' mine':'')+'">'
        +(!mine?'<div class="av" style="width:24px;height:24px;font-size:11px;background:'+getAvBg(m.from)+'">'+getAvEmoji(m.from)+'</div>':'')
        +'<div>'
          +(!mine?'<div class="dm-sender-name">'+esc(m.from)+'</div>':'')
          +'<div class="dm-bubble'+(mine?' mine':' theirs')+'">'+esc(m.text)+'</div>'
          +'<div class="dm-time" style="text-align:'+(mine?'right':'left')+'">'+timeAgo(m.ts)+'</div>'
        +'</div>'
      +'</div>';
    }).join('');
    if(msgs.length > prevLen && prevLen > 0){
      var last = msgs[msgs.length-1];
      if(last.from !== currentUser.username) showMsgPopup(last.from, last.text);
    }
    box.scrollTop = box.scrollHeight;
  });
}

async function sendGroupMessage(groupId){
  if(!currentUser) return;
  var input = document.getElementById('dmInput');
  var text = input ? input.value.trim() : ''; if(!text) return;
  input.value=''; sfx('send');
  await addDoc(col(db,'groups',groupId,'messages'),{from:currentUser.username, text:text, ts:serverTs()});
  await updateDoc(docRef(db,'groups',groupId),{lastMsg:currentUser.username+': '+text, lastTs:serverTs()}).catch(function(){});
}



async function showGroupInfo(groupId){
  if(!groupId) return;
  var grp = dmGroupCache.find(function(g){ return g.id===groupId; }) || {id:groupId, name:'Grup', members:[], icon:'ğŸ‘¥'};
  // Firestore'dan gÃ¼ncel veri al
  try {
    var snap = await getDoc(docRef(db,'groups',groupId));
    if(snap.exists()) grp = Object.assign({id:groupId}, snap.data());
  } catch(e){}

  var isCreator = grp.createdBy === currentUser.username;
  var mems = grp.members||[];

  var memberListHtml = mems.map(function(m){
    var u = allUsers.find(function(x){ return x.username===m; })||{username:m};
    return '<div style="display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--border)">'
      +'<div class="av" style="width:32px;height:32px;font-size:14px;background:'+getAvBg(m,u)+'">'+getAvEmoji(m,u)+'</div>'
      +'<span style="font-size:13px;font-weight:600">'+esc(m)+(m===currentUser.username?' (sen)':'')+'</span>'
      +(grp.createdBy===m?'<span style="font-size:10px;background:var(--accent-soft);color:var(--accent);padding:2px 7px;border-radius:20px;font-weight:700;margin-left:auto">Kurucu</span>':'')
      +(isCreator&&m!==currentUser.username?'<button data-gid="'+groupId+'" data-uid="'+esc(m)+'" onclick="kickFromGroup(this.dataset.gid,this.dataset.uid)" style="margin-left:auto;padding:3px 8px;border:none;background:#ef444415;color:var(--red);border-radius:7px;font-size:11px;cursor:pointer">Ã‡Ä±kar</button>':'')
      +'</div>';
  }).join('');

  document.getElementById('dmChat').innerHTML =
    '<div class="dm-chat-hd">'
      +'<button data-gid="'+groupId+'" onclick="openGroupChatById(this.dataset.gid)" style="padding:4px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;background:none;color:var(--muted);cursor:pointer">â† Geri</button>'
      +'<span style="font-weight:700">'+esc(grp.icon||'ğŸ‘¥')+' '+esc(grp.name)+' â€” Bilgi</span>'
    +'</div>'
    +'<div id="grpInfoPanel" data-gid="'+groupId+'" style="padding:16px;overflow-y:auto;flex:1">'
      +(isCreator?
        '<div style="background:var(--surface2);border-radius:12px;padding:12px;margin-bottom:12px">'
          +'<div style="font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px">Grup AyarlarÄ±</div>'
          +'<div style="display:flex;gap:8px;margin-bottom:8px">'
            +'<button id="grpEditEmoji" onclick="cycleGrpEditEmoji()" style="padding:8px 12px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface);font-size:20px;cursor:pointer">'+esc(grp.icon||'ğŸ‘¥')+'</button>'
            +'<input id="grpEditName" value="'+esc(grp.name)+'" style="flex:1;padding:8px 12px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface);color:var(--text);font-size:13px">'
          +'</div>'
          +'<button data-gid="'+groupId+'" onclick="saveGroupEdit(this.dataset.gid)" style="width:100%;padding:9px;border:none;border-radius:9px;background:var(--accent);color:#fff;font-size:13px;font-weight:700;cursor:pointer">ğŸ’¾ DeÄŸiÅŸiklikleri Kaydet</button>'
        +'</div>'
        +'<button data-gid="'+groupId+'" onclick="openAddMemberModal(this.dataset.gid)" style="width:100%;margin-bottom:12px;padding:9px;border:1.5px solid var(--accent);border-radius:9px;background:var(--accent-soft);color:var(--accent);font-size:13px;font-weight:700;cursor:pointer">â• Ãœye Ekle</button>'
      :'')
      +'<div style="font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px">Ãœyeler ('+mems.length+')</div>'
      +memberListHtml
      +(isCreator
        ?'<button data-gid="'+groupId+'" onclick="deleteGroup(this.dataset.gid)" style="width:100%;margin-top:16px;padding:10px;border:1.5px solid var(--red);border-radius:10px;background:#ef444415;color:var(--red);font-size:13px;font-weight:700;cursor:pointer">ğŸ—‘ï¸ Grubu Sil</button>'
        :'<button data-gid="'+groupId+'" onclick="leaveGroup(this.dataset.gid)" style="width:100%;margin-top:16px;padding:10px;border:1.5px solid var(--border);border-radius:10px;background:var(--surface2);color:var(--muted);font-size:13px;font-weight:700;cursor:pointer">ğŸšª Gruptan AyrÄ±l</button>')
    +'</div>';
}

var grpEditEmojiIdx = 0;
function cycleGrpEditEmoji(){
  grpEditEmojiIdx = (grpEditEmojiIdx+1) % GROUP_EMOJIS.length;
  var btn = document.getElementById('grpEditEmoji');
  if(btn) btn.textContent = GROUP_EMOJIS[grpEditEmojiIdx];
}

async function saveGroupEdit(groupId){
  var name = (document.getElementById('grpEditName')||{}).value.trim();
  var icon = (document.getElementById('grpEditEmoji')||{}).textContent.trim();
  if(!name){ toast('Grup adÄ± boÅŸ olamaz!'); return; }
  await updateDoc(docRef(db,'groups',groupId),{name:name, icon:icon});
  var g = dmGroupCache.find(function(x){ return x.id===groupId; });
  if(g){ g.name=name; g.icon=icon; }
  toast('Grup gÃ¼ncellendi! âœ…');
  renderDMConvList();
  showGroupInfo(groupId);
}

async function kickFromGroup(groupId, username){
  if(!confirm(username+' Ã¼yeyi gruptan Ã§Ä±karmak istediÄŸine emin misin?')) return;
  await updateDoc(docRef(db,'groups',groupId),{members:arrRemove(username)});
  toast(username+' gruptan Ã§Ä±karÄ±ldÄ±.');
  await buildDMConvList();
  showGroupInfo(groupId);
}

async function leaveGroup(groupId){
  if(!confirm('Gruptan ayrÄ±lmak istediÄŸine emin misin?')) return;
  await updateDoc(docRef(db,'groups',groupId),{members:arrRemove(currentUser.username)});
  toast('Gruptan ayrÄ±ldÄ±n.');
  activeGroupId = null;
  document.getElementById('dmChat').innerHTML='<div class="dm-empty"><div style="font-size:40px">ğŸ’¬</div><div>Bir konuÅŸma seÃ§</div></div>';
  buildDMConvList();
}

async function deleteGroup(groupId){
  if(!confirm('Grubu silmek istediÄŸine emin misin? Bu iÅŸlem geri alÄ±namaz!')) return;
  await deleteDoc(docRef(db,'groups',groupId));
  toast('Grup silindi.');
  activeGroupId = null;
  document.getElementById('dmChat').innerHTML='<div class="dm-empty"><div style="font-size:40px">ğŸ’¬</div><div>Bir konuÅŸma seÃ§</div></div>';
  buildDMConvList();
}



function openDMChat(username){
  if(!currentUser){ toast('GiriÅŸ yap!'); return; }
  activeGroupId = null;
  activeDmUser = username;
  renderDMConvList();
  if(dmUnsub){ dmUnsub(); dmUnsub=null; }
  var isFriend = (currentUser.friends||[]).indexOf(username)>=0;
  document.getElementById('dmChat').innerHTML =
    '<div class="dm-chat-hd">'
      +'<div class="av" style="width:28px;height:28px;font-size:13px;flex-shrink:0;background:'+getAvBg(username)+'">'+getAvEmoji(username)+'</div>'
      +'<div style="flex:1"><div style="font-weight:600">@'+esc(username)+'</div>'
      +'<div style="font-size:10px;color:var(--muted)">'+(isFriend?'âœ… ArkadaÅŸ':'KullanÄ±cÄ±')+'</div></div>'
      +'<button id="dmProfBtn" style="padding:4px 9px;border:1.5px solid var(--border);border-radius:8px;font-size:11px;background:none;color:var(--muted);cursor:pointer">Profil â†’</button>'
      +'<button id="dmDelBtn" class="dm-del-btn">ğŸ—‘ï¸ Sil</button>'
    +'</div>'
    +'<div class="dm-messages" id="dmMessages"><div class="dm-empty"><div style="font-size:36px">ğŸ’¬</div><div>Sohbete baÅŸla!</div></div></div>'
    +'<div class="dm-input-area">'
      +'<input class="dm-input" id="dmInput" placeholder="'+esc(username)+' kiÅŸisine mesaj yaz..."/>'
      +'<button class="dm-send" id="dmSendBtn">â¤</button>'
    +'</div>';

  var _u = username;
  document.getElementById('dmProfBtn').addEventListener('click', function(){ openProfile(_u); });
  var _db=document.getElementById('dmDelBtn'); if(_db) _db.addEventListener('click', function(){ deleteChatForMe(_u); });
  document.getElementById('dmInput').addEventListener('keydown', function(e){ if(e.key==='Enter'&&!e.shiftKey) sendDM(_u); });
  document.getElementById('dmSendBtn').addEventListener('click', function(){ sendDM(_u); });

  var dmId = getDMId(currentUser.username, username);
  var q = qry(col(db,'dms',dmId,'messages'), orderBy('ts','asc'), lmt(100));
  dmUnsub = onSnapshot(q, function(snap){
    var msgs = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    var box = document.getElementById('dmMessages');
    if(!box) return;
    if(!msgs.length){ box.innerHTML='<div class="dm-empty"><div style="font-size:36px">ğŸ’¬</div><div>HenÃ¼z mesaj yok</div></div>'; return; }
    var prevLen = box.querySelectorAll('.dm-msg').length;
    box.innerHTML = msgs.map(function(m){
      var mine = m.from===currentUser.username;
      return '<div class="dm-msg'+(mine?' mine':'')+'">'
        +(!mine?'<div class="av" style="width:24px;height:24px;font-size:11px;flex-shrink:0;background:'+getAvBg(m.from)+'">'+getAvEmoji(m.from)+'</div>':'')
        +'<div><div class="dm-bubble'+(mine?' mine':' theirs')+'">'+esc(m.text)+'</div>'
        +'<div class="dm-time" style="text-align:'+(mine?'right':'left')+'">'+timeAgo(m.ts)+'</div></div>'
      +'</div>';
    }).join('');
    if(msgs.length>prevLen && prevLen>0){
      var last=msgs[msgs.length-1];
      if(last&&last.from!==currentUser.username) showMsgPopup(last.from,last.text);
    }
    box.scrollTop=box.scrollHeight;
  });
}

async function sendDM(toUsername){
  if(!currentUser) return;
  if(!checkRateLimit()) return;
  var input=document.getElementById('dmInput');
  var text=input?input.value.trim():''; if(!text) return;
  // dmRestrict kontrolÃ¼: karÅŸÄ± taraf kÄ±sÄ±tladÄ±ysa ve biz arkadaÅŸ deÄŸilsek engelle
  var isFriend = (currentUser.friends||[]).indexOf(toUsername)>=0;
  if(!isFriend){
    try{
      var recipSnap = await getDoc(docRef(db,'users',toUsername));
      if(recipSnap.exists() && recipSnap.data().dmRestrict){
        toast('Bu kullanÄ±cÄ± DM\'leri yalnÄ±zca arkadaÅŸlarÄ±na aÃ§Ä±k ğŸ”’');
        return;
      }
    } catch(e){}
  }
  input.value=''; sfx('send');
  var dmId=getDMId(currentUser.username,toUsername);
  await setDoc(docRef(db,'dms',dmId),{participants:[currentUser.username,toUsername],lastTs:serverTs()},{merge:true});
  await addDoc(col(db,'dms',dmId,'messages'),{from:currentUser.username,text:text,ts:serverTs()});
  // KonuÅŸma listesini gÃ¼ncelle
  if(dmConvCache.indexOf(toUsername)<0){ dmConvCache.push(toUsername); renderDMConvList(); }
}

// â”€â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addNotif(toUsername,type,text,postId){
  try{
    await addDoc(col(db,'users',toUsername,'notifs'),{type:type,text:text,postId:postId||null,from:currentUser?currentUser.username:'',ts:serverTs(),read:false});
  }catch(e){}
}



// â”€â”€â”€ LISTENING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startListening(){
  if(postsUnsub) postsUnsub();
  postsUnsub=onSnapshot(qry(col(db,'posts'),orderBy('ts','desc'),lmt(80)),function(snap){
    allPosts=snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    renderFeed(); renderStories();
  });
  onSnapshot(col(db,'users'),function(snap){
    allUsers=snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    renderOnline(); renderLeaderboard();
  });
  if(currentUser){
    setInterval(function(){
      if(settings.showOnline!==false)
        updateDoc(docRef(db,'users',currentUser.username),{lastSeen:serverTs()}).catch(function(){});
    },30000);
  }
}

// â”€â”€â”€ FIREBASE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function(){
  var appMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
  var fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

  _col=fsMod.collection; _addDoc=fsMod.addDoc; _onSnapshot=fsMod.onSnapshot;
  _query=fsMod.query; _orderBy=fsMod.orderBy; _limit=fsMod.limit;
  _serverTs=fsMod.serverTimestamp; _doc=fsMod.doc; _setDoc=fsMod.setDoc;
  _getDoc=fsMod.getDoc; _updateDoc=fsMod.updateDoc; _increment=fsMod.increment;
  _getDocs=fsMod.getDocs; _deleteDoc=fsMod.deleteDoc;
  _arrayUnion=fsMod.arrayUnion; _arrayRemove=fsMod.arrayRemove;

  var fb = appMod.initializeApp({
    apiKey:'AIzaSyAjrBkmztOQPnDMZ80cLLmysfMxMbcMX_g',
    authDomain:'anon-chat-6f167.firebaseapp.com',
    projectId:'anon-chat-6f167',
    storageBucket:'anon-chat-6f167.firebasestorage.app',
    messagingSenderId:'1073093385906',
    appId:'1:1073093385906:web:52eb84f1f52666d19533ab'
  });
  db = fsMod.getFirestore(fb);

  // Gate listener'larÄ±nÄ± Firebase hazÄ±r olduktan sonra baÄŸla
  setupGateListeners();
  var gl = document.getElementById('gateLoading');
  if(gl) gl.style.display='none';

  // Session kontrol
  var saved = loadSess();
  if(saved && saved.username){
    try {
      var snap = await getDoc(docRef(db,'users',saved.username));
      if(snap.exists()){
        currentUser = Object.assign({username:saved.username}, snap.data());
        saveSess(currentUser);
        hideGate();
        afterLogin();
      } else {
        clearSess();
      }
    } catch(e){ clearSess(); }
  }
})();


// â”€â”€â”€ SHA-256 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sha256(str){
  var buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
}

// â”€â”€â”€ KAPAK GRADÄ°ENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var COVER_GRADIENTS = [
  'linear-gradient(135deg,#5b5ef4,#0ea5e9)',
  'linear-gradient(135deg,#ef4444,#f97316)',
  'linear-gradient(135deg,#22c55e,#0ea5e9)',
  'linear-gradient(135deg,#a855f7,#ec4899)',
  'linear-gradient(135deg,#f59e0b,#ef4444)',
  'linear-gradient(135deg,#0ea5e9,#22c55e)',
  'linear-gradient(135deg,#1a1d27,#5b5ef4)',
  'linear-gradient(135deg,#ec4899,#f97316)',
];
var selectedCoverGradient = null;

function openCoverModal(){
  if(!currentUser) return;
  selectedCoverGradient = currentUser.coverGradient || COVER_GRADIENTS[0];
  var grid = document.getElementById('coverGrid');
  if(!grid) return;
  grid.innerHTML = COVER_GRADIENTS.map(function(g, i){
    var active = g === selectedCoverGradient;
    return '<div onclick="pickCover('+i+')" id="cgb_'+i+'" style="height:52px;border-radius:10px;background:'+g+';cursor:pointer;border:3px solid '+(active?'#fff':'transparent')+';box-shadow:'+(active?'0 0 0 2px var(--accent)':'none')+';transition:all .15s"></div>';
  }).join('');
  document.getElementById('coverModal').classList.remove('hidden');
}
function closeCoverModal(){ document.getElementById('coverModal').classList.add('hidden'); }
function pickCover(i){
  selectedCoverGradient = COVER_GRADIENTS[i];
  document.querySelectorAll('[id^="cgb_"]').forEach(function(el, idx){
    el.style.border = '3px solid '+(idx===i?'#fff':'transparent');
    el.style.boxShadow = idx===i?'0 0 0 2px var(--accent)':'none';
  });
}
async function saveCoverColor(){
  if(!currentUser||!selectedCoverGradient) return;
  await updateDoc(docRef(db,'users',currentUser.username),{coverGradient:selectedCoverGradient});
  currentUser.coverGradient = selectedCoverGradient;
  saveSess(currentUser);
  var mpCover = document.getElementById('mpCover');
  if(mpCover) mpCover.style.background = selectedCoverGradient;
  closeCoverModal();
  toast('Kapak gÃ¼ncellendi! ğŸ¨');
}

// â”€â”€â”€ RAPORLAMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var reportTarget = null;
var reportTargetType = null;
function openReportModal(type, id){
  if(!currentUser){ toast('GiriÅŸ yap!'); return; }
  reportTarget = id; reportTargetType = type;
  var desc = document.getElementById('reportDesc');
  if(desc) desc.value = '';
  document.getElementById('reportModal').classList.remove('hidden');
}
function closeReportModal(){ document.getElementById('reportModal').classList.add('hidden'); }
async function submitReport(){
  if(!currentUser||!reportTarget) return;
  var reason = document.getElementById('reportReason').value;
  var desc = (document.getElementById('reportDesc').value||'').trim();
  await addDoc(col(db,'reports'),{
    reportedBy:currentUser.username, targetType:reportTargetType, targetId:reportTarget,
    reason:reason, desc:desc, ts:serverTs(), resolved:false
  });
  closeReportModal();
  toast('Rapor gÃ¶nderildi! ğŸš©');
}

// â”€â”€â”€ BÄ°LDÄ°RÄ°M SÄ°STEMÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var notifUnsub = null;
function startNotifListener(){
  if(!currentUser) return;
  if(notifUnsub){ notifUnsub(); notifUnsub=null; }
  // KullanÄ±cÄ± doc'u dinle - arkadaÅŸlÄ±k istekleri iÃ§in
  onSnapshot(docRef(db,'users',currentUser.username), function(snap){
    if(!snap.exists()) return;
    var d = snap.data();
    currentUser.friends = d.friends||[];
    currentUser.friendRequests = d.friendRequests||[];
    currentUser.sentRequests = d.sentRequests||[];
    saveSess(currentUser);
    updateNotifBadge();
  });
  // Bildirim koleksiyonu dinle
  notifUnsub = onSnapshot(
    qry(col(db,'users',currentUser.username,'notifs'), orderBy('ts','desc'), lmt(30)),
    function(snap){
      var unread = snap.docs.filter(function(d){ return !d.data().read; }).length;
      updateNotifBadge(unread);
    }
  );
}

function updateNotifBadge(extraUnread){
  var req = (currentUser.friendRequests||[]).length;
  var total = req + (extraUnread||0);
  var b = document.getElementById('notifBadge');
  if(b){ b.textContent = total; b.classList.toggle('hidden', total===0); }
}

function renderNotifs(){
  if(!currentUser){ document.getElementById('notifsList').innerHTML='<div style="padding:20px;text-align:center;color:var(--muted)">GiriÅŸ yap.</div>'; return; }
  var list = document.getElementById('notifsList');
  list.innerHTML = '<div class="loading"><div class="ld"></div><div class="ld"></div><div class="ld"></div></div>';

  var friendReqs = currentUser.friendRequests||[];
  var reqHtml = '';
  if(friendReqs.length){
    reqHtml = '<div style="padding:10px 14px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border)">ğŸ‘¥ ArkadaÅŸlÄ±k Ä°stekleri</div>';
    reqHtml += friendReqs.map(function(f){
      var u = allUsers.find(function(x){ return x.username===f; })||{username:f};
      return '<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)">'
        +mkAv(f,u,36)
        +'<div style="flex:1"><div style="font-weight:700;font-size:13px">'+esc(f)+'</div><div style="font-size:12px;color:var(--muted)">ArkadaÅŸlÄ±k isteÄŸi gÃ¶nderdi ğŸ¤</div></div>'
        +'<div style="display:flex;gap:6px">'
          +'<button class="fr-accept" style="font-size:12px;padding:5px 12px" data-u="'+esc(f)+'" onclick="acceptFriendRequest(this.dataset.u).then(function(){renderNotifs();})">Kabul</button>'
          +'<button class="fr-reject" style="font-size:12px;padding:5px 10px" data-u="'+esc(f)+'" onclick="rejectFriendRequest(this.dataset.u).then(function(){renderNotifs();})">Reddet</button>'
        +'</div>'
      +'</div>';
    }).join('');
  }

  getDocs(qry(col(db,'users',currentUser.username,'notifs'),orderBy('ts','desc'),lmt(30))).then(function(snap){
    var notifs = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    var nHtml = '';
    if(notifs.length){
      nHtml = '<div style="padding:10px 14px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border)">ğŸ”” Bildirimler</div>';
      nHtml += notifs.map(function(n){
        var icon = n.type==='like'?'â¤ï¸':n.type==='comment'?'ğŸ’¬':'ğŸ‘¥';
        return '<div class="notif-item'+(n.read?'':' unread')+'" '+(n.postId?'style="cursor:pointer" data-pid="'+n.postId+'" onclick="openPost(this.dataset.pid)"':'')+' style="'+(n.postId?'cursor:pointer':'')+'">'+
          '<span style="font-size:20px">'+icon+'</span>'+
          '<div class="notif-text">'+esc(n.text)+'</div>'+
          '<div class="notif-time">'+timeAgo(n.ts)+'</div>'+
        '</div>';
      }).join('');
      snap.docs.forEach(function(d){ if(!d.data().read) updateDoc(d.ref,{read:true}).catch(function(){}); });
    }
    var combined = reqHtml + nHtml;
    list.innerHTML = combined || '<div style="padding:32px;text-align:center;color:var(--muted)"><div style="font-size:40px">ğŸ””</div><div style="margin-top:8px">HenÃ¼z bildirim yok</div></div>';
    updateNotifBadge(0);
  });
}

// â”€â”€â”€ RATE LÄ°MÄ°T & BRUTE FORCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var postTimestamps = [];
var loginFailCount = 0;
var loginBlockUntil = 0;
function checkRateLimit(){
  var now = Date.now();
  postTimestamps = postTimestamps.filter(function(t){ return now-t < 30000; });
  if(postTimestamps.length >= 5){ toast('Ã‡ok hÄ±zlÄ±! Biraz bekle â±ï¸'); return false; }
  postTimestamps.push(now);
  return true;
}
function checkBruteForce(){
  var now = Date.now();
  if(loginBlockUntil > now){
    toast('Ã‡ok fazla hatalÄ± giriÅŸ! '+Math.ceil((loginBlockUntil-now)/1000)+' saniye bekle ğŸ”’');
    return false;
  }
  return true;
}

// â”€â”€â”€ ADMIN PANELÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ADMIN_USERNAME = 'ErayXxx';
var ADMIN_PASSWORD = 'I3cR4piQfdxw';
function isAdmin(){ return currentUser && currentUser.username === ADMIN_USERNAME; }

function openAdminPanel(){
  if(!isAdmin()){ toast('Yetkisiz eriÅŸim!'); return; }
  document.getElementById('adminPanel').classList.remove('hidden');
  adminTab('users');
}
function closeAdminPanel(){ document.getElementById('adminPanel').classList.add('hidden'); }
function adminTab(tab){
  ['users','posts','groups','reports'].forEach(function(t){
    var btn = document.getElementById('atab-'+t);
    if(btn) btn.classList.toggle('active', t===tab);
  });
  if(tab==='users') adminRenderUsers();
  else if(tab==='posts') adminRenderPosts();
  else if(tab==='groups') adminRenderGroups();
  else if(tab==='reports') adminRenderReports();
}
function adminRenderUsers(){
  var body = document.getElementById('adminBody');
  body.innerHTML = '<input class="g-input" placeholder="KullanÄ±cÄ± ara..." oninput="adminFilterUsers(this.value)" style="margin-bottom:12px"/><div id="adminUserList"></div>';
  adminFilterUsers('');
}
function adminFilterUsers(q){
  var list = document.getElementById('adminUserList'); if(!list) return;
  var filtered = q ? allUsers.filter(function(u){ return u.username.toLowerCase().includes(q.toLowerCase()); }) : allUsers;
  list.innerHTML = filtered.slice(0,50).map(function(u){
    return '<div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--border)">'
      +mkAv(u.username,u,36)
      +'<div style="flex:1"><div style="font-weight:700;font-size:13px">'+esc(u.username)+'</div>'
        +'<div style="font-size:11px;color:var(--muted)">'+(u.postCount||0)+' gÃ¶nderi Â· '+(u.friends||[]).length+' arkadaÅŸ</div></div>'
      +'<button class="adm-btn adm-btn-red" data-u="'+esc(u.username)+'" onclick="adminDelUser(this.dataset.u)" '+(u.username===ADMIN_USERNAME?'disabled':'')+'>'+(u.username===ADMIN_USERNAME?'Admin':'Sil')+'</button>'
    +'</div>';
  }).join('') || '<div style="padding:20px;color:var(--muted);text-align:center">KullanÄ±cÄ± bulunamadÄ±</div>';
}
async function adminDelUser(username){
  if(username===ADMIN_USERNAME){ toast('Admin silinemez!'); return; }
  if(!confirm(username+' kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinden emin misin?')) return;
  await deleteDoc(docRef(db,'users',username));
  allUsers = allUsers.filter(function(u){ return u.username!==username; });
  toast(username+' silindi.');
  adminFilterUsers('');
}
function adminRenderPosts(){
  var body = document.getElementById('adminBody');
  body.innerHTML = allPosts.slice(0,50).map(function(p){
    return '<div style="padding:10px;border-bottom:1px solid var(--border)">'
      +'<div style="font-size:12px;font-weight:700;color:var(--accent)">@'+esc(p.author||'?')+'</div>'
      +'<div style="font-size:13px;margin:4px 0">'+esc((p.text||'').substring(0,100))+'</div>'
      +'<button class="adm-btn adm-btn-red" data-pid="'+p.id+'" onclick="adminDelPost(this.dataset.pid)">Sil</button>'
    +'</div>';
  }).join('') || '<div style="padding:20px;color:var(--muted);text-align:center">GÃ¶nderi yok</div>';
}
async function adminDelPost(pid){
  if(!confirm('GÃ¶nderiyi silmek istediÄŸinden emin misin?')) return;
  await deleteDoc(docRef(db,'posts',pid));
  allPosts = allPosts.filter(function(p){ return p.id!==pid; });
  toast('GÃ¶nderi silindi.');
  adminRenderPosts();
}
function adminRenderGroups(){
  getDocs(col(db,'groups')).then(function(snap){
    var body = document.getElementById('adminBody');
    var groups = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    body.innerHTML = groups.map(function(g){
      return '<div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--border)">'
        +'<div style="font-size:24px">'+esc(g.icon||'ğŸ‘¥')+'</div>'
        +'<div style="flex:1"><div style="font-weight:700;font-size:13px">'+esc(g.name)+'</div>'
          +'<div style="font-size:11px;color:var(--muted)">'+(g.members||[]).length+' Ã¼ye Â· Kurucu: '+esc(g.createdBy||'?')+'</div></div>'
        +'<button class="adm-btn adm-btn-red" data-gid="'+g.id+'" onclick="adminDelGroup(this.dataset.gid)">Sil</button>'
      +'</div>';
    }).join('') || '<div style="padding:20px;color:var(--muted);text-align:center">Grup yok</div>';
  });
}
async function adminDelGroup(gid){
  if(!confirm('Grubu silmek istediÄŸinden emin misin?')) return;
  await deleteDoc(docRef(db,'groups',gid));
  toast('Grup silindi.');
  adminRenderGroups();
}
function adminRenderReports(){
  getDocs(qry(col(db,'reports'),orderBy('ts','desc'),lmt(50))).then(function(snap){
    var body = document.getElementById('adminBody');
    var reports = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    if(!reports.length){ body.innerHTML='<div style="padding:32px;text-align:center;color:var(--muted)"><div style="font-size:32px">ğŸš©</div>HenÃ¼z rapor yok</div>'; return; }
    var labels = {spam:'Spam',hatespeech:'Nefret',harassment:'Taciz',inappropriate:'Uygunsuz',fake:'Sahte',other:'DiÄŸer'};
    body.innerHTML = reports.map(function(r){
      return '<div style="padding:12px;border:1.5px solid var(--border);border-radius:10px;margin-bottom:8px">'
        +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
          +'<span style="font-weight:700">ğŸš© '+(labels[r.reason]||r.reason)+'</span>'
          +'<span style="font-size:10px;padding:2px 7px;border-radius:20px;background:'+(r.resolved?'#22c55e20':'#ef444415')+';color:'+(r.resolved?'#22c55e':'#ef4444')+';font-weight:700">'+(r.resolved?'Ã‡Ã¶zÃ¼ldÃ¼':'Bekliyor')+'</span>'
          +'<span style="font-size:11px;color:var(--muted);margin-left:auto">'+timeAgo(r.ts)+'</span>'
        +'</div>'
        +'<div style="font-size:12px;color:var(--muted);margin-bottom:6px">'+esc(r.reportedBy)+' â†’ '+esc(r.targetType)+': '+esc(r.targetId)+'</div>'
        +(r.desc?'<div style="font-size:12px;padding:6px 10px;background:var(--surface2);border-radius:8px;margin-bottom:8px">'+esc(r.desc)+'</div>':'')
        +'<div style="display:flex;gap:6px">'
          +(!r.resolved?'<button class="adm-btn adm-btn-blue" data-rid="'+r.id+'" onclick="adminResolveReport(this.dataset.rid)">Ã‡Ã¶zÃ¼ldÃ¼</button>':'')
          +'<button class="adm-btn adm-btn-red" data-rid="'+r.id+'" onclick="adminDelReport(this.dataset.rid)">Sil</button>'
        +'</div>'
      +'</div>';
    }).join('');
  }).catch(function(){ document.getElementById('adminBody').innerHTML='<div style="color:var(--red);padding:16px">Raporlar yÃ¼klenemedi.</div>'; });
}
async function adminResolveReport(id){
  await updateDoc(docRef(db,'reports',id),{resolved:true});
  toast('Rapor Ã§Ã¶zÃ¼ldÃ¼ olarak iÅŸaretlendi.');
  adminRenderReports();
}
async function adminDelReport(id){
  await deleteDoc(docRef(db,'reports',id));
  toast('Rapor silindi.');
  adminRenderReports();
}

// â”€â”€â”€ ADMIN HESABI OTO OLUÅTUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ensureAdminAccount(){
  try {
    var snap = await getDoc(docRef(db,'users',ADMIN_USERNAME));
    if(!snap.exists()){
      var hashed = await sha256(ADMIN_PASSWORD);
      await setDoc(docRef(db,'users',ADMIN_USERNAME),{
        username:ADMIN_USERNAME, password:hashed, joinedAt:serverTs(),
        postCount:0, commentCount:0, likeCount:0, savedPosts:[], friends:[],
        friendRequests:[], sentRequests:[], isPrivate:false, dmRestrict:false,
        lastSeen:serverTs(), avEmoji:'ğŸ‘‘', avColor:'#ef4444', isAdmin:true
      });
      console.log('Admin hesabÄ± oluÅŸturuldu.');
    }
  } catch(e){ console.error('Admin init:', e); }
}



function openMyProfile(){ if(currentUser) openProfile(currentUser.username); }

// â•â•â• YENÄ° Ã–ZELLÄ°KLER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var GROUP_EMOJIS = ['ğŸ‘¥','ğŸ®','ğŸ“š','ğŸµ','ğŸ’»','ğŸ†','ğŸ¨','ğŸ•','âš½','ğŸŒŸ','ğŸ”¥','ğŸ’¬','ğŸ¯','ğŸš€','â¤ï¸','ğŸ‰','ğŸ¤','ğŸ’¡','ğŸ ','ğŸ­'];
var groupEmojiIdx = 0;
function cycleGroupEmoji(){
  groupEmojiIdx=(groupEmojiIdx+1)%GROUP_EMOJIS.length;
  var b=document.getElementById('groupEmojiBtn'); if(b) b.textContent=GROUP_EMOJIS[groupEmojiIdx];
}

function arrUnionArr(arr){ return _arrayUnion.apply(null, arr); }

// Lider tablosu gizleme
async function toggleLeaderboard(val){
  if(!currentUser) return;
  currentUser.showOnLeaderboard=val; saveSess(currentUser);
  await updateDoc(docRef(db,'users',currentUser.username),{showOnLeaderboard:val});
  toast(val?'Lider tablosunda gÃ¶rÃ¼nÃ¼yorsun ğŸ†':'Lider tablosundan gizlendin','info');
}

// Mesaj popup

// PaylaÅŸ
function sharePost(postId){
  var url=window.location.href.split('?')[0]+'?post='+postId;
  if(navigator.clipboard){ navigator.clipboard.writeText(url).then(function(){ toast('Link kopyalandÄ±! ğŸ”—','success'); }).catch(function(){ prompt('Linki kopyala:',url); }); }
  else prompt('Linki kopyala:',url);
}

// Profil ziyareti
async function trackProfileVisit(username){
  if(!currentUser||username===currentUser.username) return;
  try{ await updateDoc(docRef(db,'users',username),{profileViews:incr(1)}); }catch(e){}
}

// URL param
function checkUrlParams(){
  var params=new URLSearchParams(window.location.search);
  var pid=params.get('post');
  if(pid&&currentUser) setTimeout(function(){ openPost(pid); },500);
}

// Online sayaÃ§
function updateOnlineCount(){
  var now=Date.now();
  var n=allUsers.filter(function(u){ var ms=u.lastSeen&&u.lastSeen.toMillis?u.lastSeen.toMillis():0; return ms&&(now-ms<180000); }).length;
  var b=document.getElementById('onlineNavBadge'); if(b) b.textContent=n>0?'ğŸŸ¢ '+n+' Ã§evrimiÃ§i':'';
}

// ArkadaÅŸ Ã¶nerisi
function getSuggestedFriends(){
  if(!currentUser) return [];
  var myF=currentUser.friends||[];
  var sugg={};
  allUsers.forEach(function(u){
    if(u.username===currentUser.username) return;
    if(myF.indexOf(u.username)>=0) return;
    if((currentUser.sentRequests||[]).indexOf(u.username)>=0) return;
    var mutual=(u.friends||[]).filter(function(f){ return myF.indexOf(f)>=0; }).length;
    if(mutual>0) sugg[u.username]={user:u,mutual:mutual};
  });
  return Object.values(sugg).sort(function(a,b){ return b.mutual-a.mutual; }).slice(0,4);
}

function renderFriendSuggestions(){
  var box=document.getElementById('friendSuggestions'); if(!box||!currentUser) return;
  var s=getSuggestedFriends();
  if(!s.length){ box.style.display='none'; return; }
  box.style.display='block';
  box.innerHTML='<div class="card-hd" style="padding:12px 14px 8px">ğŸ‘¥ TanÄ±yor Olabilirsin</div>'
    +s.map(function(x){
      return '<div style="display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border)">'
        +'<div class="av" style="width:36px;height:36px;font-size:16px;background:'+getAvBg(x.user.username,x.user)+';cursor:pointer" data-u="'+esc(x.user.username)+'" onclick="openProfile(this.dataset.u)">'+getAvEmoji(x.user.username,x.user)+'</div>'
        +'<div style="flex:1;cursor:pointer" data-u="'+esc(x.user.username)+'" onclick="openProfile(this.dataset.u)">'
          +'<div style="font-size:13px;font-weight:600">'+esc(x.user.username)+'</div>'
          +'<div style="font-size:11px;color:var(--muted)">'+x.mutual+' ortak arkadaÅŸ</div>'
        +'</div>'
        +'<button class="fr-btn" style="padding:5px 12px;font-size:12px;border-radius:8px;border:1.5px solid var(--accent);background:var(--accent-soft);color:var(--accent);cursor:pointer;font-weight:600" data-u="'+esc(x.user.username)+'" onclick="sendFriendRequest(this.dataset.u)">+ Ekle</button>'
      +'</div>';
    }).join('');
}

// KaranlÄ±k mod animasyonlu
function toggleDarkAnimated(val){
  document.body.style.transition='background .3s,color .3s';
  toggleDark(val);
  setTimeout(function(){ document.body.style.transition=''; },400);
}



// â”€â”€â”€ SES SÄ°STEMÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _audioCtx=null, soundEnabled=true;
function getAudioCtx(){ if(!_audioCtx) try{_audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){} return _audioCtx; }
function playSound(type){
  var ctx=getAudioCtx(); if(!ctx) return;
  var osc=ctx.createOscillator(),gain=ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  var c={send:[880,1100,.12,.08],receive:[660,880,.22,.10],like:[523,659,.18,.08],notif:[440,554,.25,.09],friend:[392,523,.28,.09],error:[220,196,.20,.07],success:[587,784,.20,.08],post:[659,880,.25,.07],delete:[330,220,.18,.06]}[type]||[440,554,.2,.08];
  osc.type='sine';
  osc.frequency.setValueAtTime(c[0],ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(c[1],ctx.currentTime+c[2]*.7);
  gain.gain.setValueAtTime(c[3],ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+c[2]);
  osc.start(ctx.currentTime); osc.stop(ctx.currentTime+c[2]);
}
function sfx(type){ if(soundEnabled) try{playSound(type);}catch(e){} }

// â”€â”€â”€ EFEKTLÄ° MESAJ BÄ°LDÄ°RÄ°MÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMsgPopup(from,text){
  sfx('receive');
  var old=document.getElementById('msgPopup');
  if(old){ old.style.animation='msgPopupOut .3s ease forwards'; setTimeout(function(){ if(old.parentNode) old.remove(); },300); }
  setTimeout(function(){
    var d=document.createElement('div'); d.id='msgPopup';
    d.innerHTML='<div class="mp-av-wrap"><div class="av" style="width:38px;height:38px;font-size:17px;background:'+getAvBg(from)+'">'+getAvEmoji(from)+'</div><div class="mp-ping"></div></div>'
      +'<div class="mp-body"><div class="mp-name">'+esc(from)+'</div><div class="mp-text">'+esc(text)+'</div></div>'
      +'<button class="mp-close" onclick="event.stopPropagation();this.parentNode.remove()">x</button>'
      +'<div class="mp-progress"></div>';
    d.addEventListener('click',function(e){ if(e.target.classList.contains('mp-close')) return; openDMWith(from); d.remove(); });
    document.body.appendChild(d);
    setTimeout(function(){ if(d.parentNode){ d.style.animation='msgPopupOut .35s ease forwards'; setTimeout(function(){ if(d.parentNode) d.remove(); },350); } },4200);
  }, old?300:0);
}

// â”€â”€â”€ SOHBETÄ° SÄ°L (SADECE SENDEN) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteChatForMe(username){
  if(!currentUser) return;
  if(!confirm('Bu sohbet sadece sende silinecek. KarÅŸÄ± tarafta durmaya devam edecek. Devam?')) return;
  var dmId=getDMId(currentUser.username,username);
  try{
    await setDoc(docRef(db,'dms',dmId),{['hiddenFor_'+currentUser.username]:serverTs()},{merge:true});
    sfx('delete'); toast('Sohbet silindi ğŸ—‘ï¸','info');
    dmConvCache=dmConvCache.filter(function(u){ return u!==username; });
    activeDmUser=null;
    document.getElementById('dmChat').innerHTML='<div class="dm-empty"><div style="font-size:40px">ğŸ’¬</div><div>Bir konuÅŸma seÃ§</div></div>';
    renderDMConvList();
  }catch(e){ toast('Hata: '+e.message,'error'); }
}
async function deleteGroupChatForMe(groupId){
  if(!currentUser) return;
  if(!confirm('Grup sohbeti sende gizlenecek. Gruba Ã¼ye kalmaya devam edeceksin. Devam?')) return;
  try{
    await updateDoc(docRef(db,'groups',groupId),{['hiddenFor_'+currentUser.username]:serverTs()});
    sfx('delete'); toast('Sohbet gizlendi ğŸ—‘ï¸','info');
    activeGroupId=null;
    document.getElementById('dmChat').innerHTML='<div class="dm-empty"><div style="font-size:40px">ğŸ’¬</div><div>Bir konuÅŸma seÃ§</div></div>';
    buildDMConvList();
  }catch(e){ toast('Hata: '+e.message,'error'); }
}

// â”€â”€â”€ ADMÄ°N HIZLI SÄ°L â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminQuickDelPost(pid){
  if(!isAdmin()) return;
  if(!confirm('Bu gÃ¶nderiyi admin olarak silmek istediÄŸine emin misin?')) return;
  sfx('delete');
  await deleteDoc(docRef(db,'posts',pid));
  allPosts=allPosts.filter(function(p){ return p.id!==pid; });
  renderFeed(); toast('GÃ¶nderi silindi.','success');
}

</script>

    <!-- KAPAK SEÃ‡Ä°CÄ° MODAL -->
    <div class="overlay hidden" id="coverModal">
      <div class="modal" style="max-width:380px">
        <div class="modal-title">ğŸ¨ Kapak Rengi SeÃ§ <button class="modal-close" onclick="closeCoverModal()">âœ•</button></div>
        <div id="coverGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;"></div>
        <button class="g-btn" onclick="saveCoverColor()">Kaydet</button>
      </div>
    </div>

    <!-- RAPORLAMA MODAL -->
    <div class="overlay hidden" id="reportModal">
      <div class="modal" style="max-width:400px">
        <div class="modal-title">ğŸš© Raporla <button class="modal-close" onclick="closeReportModal()">âœ•</button></div>
        <div style="margin-bottom:12px">
          <div class="g-label">Rapor Sebebi</div>
          <select id="reportReason" style="width:100%;padding:10px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px">
            <option value="spam">Spam / Reklam</option>
            <option value="hatespeech">Nefret SÃ¶ylemi</option>
            <option value="harassment">Taciz / ZorbalÄ±k</option>
            <option value="inappropriate">Uygunsuz Ä°Ã§erik</option>
            <option value="fake">Sahte Hesap</option>
            <option value="other">DiÄŸer</option>
          </select>
        </div>
        <div style="margin-bottom:16px">
          <div class="g-label">AÃ§Ä±klama (Ä°steÄŸe BaÄŸlÄ±)</div>
          <textarea id="reportDesc" style="width:100%;padding:10px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;resize:none;height:80px" placeholder="Ek bilgi..."></textarea>
        </div>
        <button class="g-btn" onclick="submitReport()">Raporu GÃ¶nder ğŸš©</button>
      </div>
    </div>

    <!-- ADMIN PANELÄ° -->
    <div class="overlay hidden" id="adminPanel">
      <div class="modal" style="max-width:600px;height:80vh;display:flex;flex-direction:column">
        <div class="modal-title">âš™ï¸ Admin Paneli <button class="modal-close" onclick="closeAdminPanel()">âœ•</button></div>
        <div style="display:flex;gap:6px;margin-bottom:14px;flex-shrink:0">
          <button class="admin-tab active" id="atab-users" onclick="adminTab('users')">KullanÄ±cÄ±lar</button>
          <button class="admin-tab" id="atab-posts" onclick="adminTab('posts')">GÃ¶nderiler</button>
          <button class="admin-tab" id="atab-groups" onclick="adminTab('groups')">Gruplar</button>
          <button class="admin-tab" id="atab-reports" onclick="adminTab('reports')">ğŸš© Raporlar</button>
        </div>
        <div id="adminBody" style="flex:1;overflow-y:auto"></div>
      </div>
    </div>

<div class="toast-wrap" id="toastWrap"></div>
</body>
</html>
